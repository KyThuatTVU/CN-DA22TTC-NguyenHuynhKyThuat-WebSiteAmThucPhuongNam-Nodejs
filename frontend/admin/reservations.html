<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Đặt bàn - Admin</title>
    <link rel="icon" type="image/png" href="../images/Green Simple Clean Vegan Food Logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="admin-styles.css">
    <link rel="stylesheet" href="admin-responsive.css">
    <style>
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-72 flex-shrink-0">
            <div class="h-full flex flex-col">
                <div class="p-5 border-b border-white/10">
                    <div class="flex items-center space-x-3">
                        <img src="../images/Green Simple Clean Vegan Food Logo.png" alt="Logo" class="w-11 h-11 rounded-xl object-contain bg-white p-1">
                        <div><h1 class="font-bold text-white text-lg">Phương Nam</h1><p class="text-xs text-blue-300">Hệ thống quản trị</p></div>
                    </div>
                </div>
                <nav class="flex-1 overflow-y-auto p-4">
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Menu chính</p>
                    <div class="space-y-1">
                        <a href="dashboard.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-chart-pie w-5"></i><span class="text-sm">Tổng quan</span></a>
                        <a href="products.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-utensils w-5"></i><span class="text-sm">Món ăn</span></a>
                        <a href="orders.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-shopping-cart w-5"></i><span class="text-sm">Đơn hàng</span></a>
                        <a href="reservations.html" class="sidebar-item active flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-calendar-check w-5"></i><span class="text-sm font-medium">Đặt bàn</span></a>
                        <a href="customers.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-users w-5"></i><span class="text-sm">Khách hàng</span></a>
                        <a href="contacts.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-envelope w-5"></i><span class="text-sm">Liên hệ</span></a>
                        <a href="chatbot-history.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-robot w-5"></i><span class="text-sm">Lịch sử Chatbot</span></a>
                        <a href="reviews.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-star w-5"></i><span class="text-sm">Đánh giá</span></a>
                        <a href="promotions.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-ticket-alt w-5"></i><span class="text-sm">Khuyến mãi</span></a>
                    </div>
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-3">Nội dung</p>
                    <div class="space-y-1">
                        <a href="news.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-newspaper w-5"></i><span class="text-sm">Tin tức</span></a>
                        <a href="quan-ly-binh-luan.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-comments w-5"></i><span class="text-sm">Bình luận tin tức</span></a>
                        <a href="quan-ly-danh-gia-tin-tuc.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-thumbs-up w-5"></i><span class="text-sm">Reactions tin tức</span></a>
                        <a href="albums.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-images w-5"></i><span class="text-sm">Album ảnh</span></a>
                    </div>
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-3">Hệ thống</p>
                    <div class="space-y-1">
                        <a href="settings.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl"><i class="fas fa-cog w-5"></i><span class="text-sm">Cài đặt</span></a>
                    </div>
                </nav>
                <div class="p-4 border-t border-white/10">
                    <div class="admin-card">
                        <div class="flex items-center space-x-3">
                            <img id="admin-avatar" referrerpolicy="no-referrer" src="https://ui-avatars.com/api/?name=Admin&background=3b82f6&color=fff" alt="Admin" class="w-12 h-12 rounded-full border-2 border-blue-400">
                            <div class="flex-1 min-w-0"><p id="admin-name" class="font-semibold text-sm text-white truncate">Đang tải...</p><p id="admin-email" class="text-xs text-blue-300 truncate">admin@example.com</p></div>
                        </div>
                        <div class="flex items-center justify-between mt-3 pt-3 border-t border-white/20">
                            <span class="text-xs text-blue-300"><i class="fab fa-google mr-1"></i>Google</span>
                            <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300"><i class="fas fa-sign-out-alt mr-1"></i>Đăng xuất</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Sidebar Overlay -->
            <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
            
            <header class="header-bar flex items-center justify-between">
                <div class="flex items-center space-x-3 sm:space-x-4">
                    <button onclick="toggleSidebar()" class="mobile-menu-btn lg:hidden text-white"><i class="fas fa-bars text-xl"></i></button>
                    <div><h2 class="text-base sm:text-xl font-bold">Quản lý Đặt bàn</h2><p class="text-xs sm:text-sm text-blue-200 hidden sm:block">Theo dõi và xử lý đặt bàn</p></div>
                </div>
                <a href="../index.html" target="_blank" class="text-white hover:text-blue-200"><i class="fas fa-external-link-alt"></i></a>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
                    <div class="stat-card"><div class="flex items-center justify-between"><div><p class="text-slate-500 text-sm">Chờ xác nhận</p><p id="stat-pending" class="text-2xl font-bold text-amber-600">0</p></div><div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center"><i class="fas fa-clock text-amber-600 text-xl"></i></div></div></div>
                    <div class="stat-card"><div class="flex items-center justify-between"><div><p class="text-slate-500 text-sm">Đã xác nhận</p><p id="stat-confirmed" class="text-2xl font-bold text-blue-600">0</p></div><div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center"><i class="fas fa-check-circle text-blue-600 text-xl"></i></div></div></div>
                    <div class="stat-card"><div class="flex items-center justify-between"><div><p class="text-slate-500 text-sm">Đã xác nhận (Admin)</p><p id="stat-attended" class="text-2xl font-bold text-emerald-600">0</p></div><div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center"><i class="fas fa-check-double text-emerald-600 text-xl"></i></div></div></div>
                    <div class="stat-card"><div class="flex items-center justify-between"><div><p class="text-slate-500 text-sm">Đã hủy</p><p id="stat-cancelled" class="text-2xl font-bold text-red-600">0</p></div><div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center"><i class="fas fa-times-circle text-red-600 text-xl"></i></div></div></div>
                </div>

                <!-- Filters -->
                <div class="content-card mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <input type="text" id="search" placeholder="Tìm tên, SĐT..." class="px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        <select id="status-filter" class="px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả trạng thái</option>
                            <option value="pending">Chờ xác nhận</option>
                            <option value="confirmed">Đã xác nhận</option>
                            <option value="attended">Đã xác nhận (Admin)</option>
                            <option value="cancelled">Đã hủy</option>
                        </select>
                        <input type="date" id="date-filter" class="px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        <select id="time-filter" class="px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả giờ</option>
                            <option value="morning">Sáng (6h-11h)</option>
                            <option value="afternoon">Trưa (11h-14h)</option>
                            <option value="evening">Tối (18h-22h)</option>
                        </select>
                        <button onclick="applyFilters()" class="bg-slate-800 text-white px-4 py-2.5 rounded-xl hover:bg-slate-900"><i class="fas fa-filter mr-2"></i>Lọc</button>
                    </div>
                </div>

                <!-- Reservations Table -->
                <div class="content-card overflow-hidden p-0">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50 border-b">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Mã</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Khách hàng</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Liên hệ</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Ngày đặt</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Giờ</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Số người</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Món đặt trước</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Thanh toán</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Trạng thái</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="reservations-tbody" class="divide-y divide-slate-100">
                                <tr><td colspan="10" class="px-6 py-12 text-center text-slate-500"><i class="fas fa-spinner fa-spin text-3xl mb-2"></i><p>Đang tải...</p></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Detail Modal -->
                <div id="detail-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-5 flex items-center justify-between">
                            <h3 class="text-xl font-bold text-white">
                                <i class="fas fa-calendar-check mr-2"></i>Chi tiết đặt bàn <span id="modal-id"></span>
                            </h3>
                            <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                            <!-- Customer Info -->
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-user text-blue-600 mr-2"></i>Thông tin khách hàng
                                </h4>
                                <div class="grid grid-cols-2 gap-4 bg-gray-50 rounded-xl p-4">
                                    <div>
                                        <p class="text-sm text-gray-500">Họ tên</p>
                                        <p id="modal-name" class="font-semibold text-gray-800"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Số điện thoại</p>
                                        <p id="modal-phone" class="font-semibold text-gray-800"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Tài khoản</p>
                                        <p id="modal-user" class="font-semibold text-gray-800"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Thời gian đặt</p>
                                        <p id="modal-created" class="font-semibold text-gray-800"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Booking Info -->
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-calendar text-green-600 mr-2"></i>Thông tin đặt bàn
                                </h4>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 bg-green-50 rounded-xl p-4">
                                    <div>
                                        <p class="text-sm text-gray-500">Ngày đến</p>
                                        <p id="modal-date" class="font-bold text-green-700"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Giờ đến</p>
                                        <p id="modal-time" class="font-bold text-green-700"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Số khách</p>
                                        <p id="modal-guests" class="font-bold text-green-700"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Trạng thái</p>
                                        <p id="modal-status" class="font-bold"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Thanh toán</p>
                                        <p id="modal-payment-status" class="font-bold"></p>
                                    </div>
                                </div>
                                <div id="modal-note" class="mt-3 p-3 bg-yellow-50 rounded-lg hidden">
                                    <p class="text-sm text-gray-500 mb-1"><i class="fas fa-sticky-note text-yellow-600 mr-1"></i>Ghi chú:</p>
                                    <p id="modal-note-text" class="text-gray-700"></p>
                                </div>
                            </div>

                            <!-- Pre-ordered Items -->
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-utensils text-orange-600 mr-2"></i>Món ăn đặt trước
                                    <span id="modal-items-count" class="ml-2 px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full text-sm"></span>
                                </h4>
                                <div id="modal-items-list" class="space-y-2">
                                    <!-- Items will be rendered here -->
                                </div>
                                <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
                                    <span class="font-bold text-gray-700">Tổng dự kiến:</span>
                                    <span id="modal-total" class="text-2xl font-bold text-orange-600"></span>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="flex gap-3">
                                <button onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-300 transition">
                                    Đóng
                                </button>
                                <button id="modal-print-btn" onclick="printReservation()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-medium hover:bg-blue-700 transition">
                                    <i class="fas fa-print mr-2"></i>In phiếu
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="check-auth.js"></script>
    <script src="admin-layout.js"></script>
    <script src="admin-mobile.js"></script>

    <script>
        // API_URL đã được khai báo trong admin-layout.js
        let reservations = [];
        let currentReservation = null;

        async function loadReservations() {
            try {
                const response = await fetch(`${API_URL}/reservations`, { credentials: 'include' });
                const data = await response.json();
                if (data.success) { reservations = data.data || []; updateStats(); renderReservations(reservations); }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('reservations-tbody').innerHTML = `<tr><td colspan="10" class="px-6 py-12 text-center text-red-500"><i class="fas fa-exclamation-triangle text-2xl mb-2"></i><p>Không thể tải dữ liệu</p></td></tr>`;
            }
        }

        function updateStats() {
            const stats = { pending: 0, confirmed: 0, attended: 0, cancelled: 0 };
            reservations.forEach(r => { if (stats[r.trang_thai] !== undefined) stats[r.trang_thai]++; });
            document.getElementById('stat-pending').textContent = stats.pending;
            document.getElementById('stat-confirmed').textContent = stats.confirmed;
            document.getElementById('stat-attended').textContent = stats.attended;
            document.getElementById('stat-cancelled').textContent = stats.cancelled;
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price || 0);
        }

        function getPaymentStatusBadge(status) {
            const statusMap = {
                'unpaid': { text: 'Chưa TT', class: 'bg-gray-100 text-gray-700', icon: 'fa-clock' },
                'pending': { text: 'Đang xử lý', class: 'bg-yellow-100 text-yellow-700', icon: 'fa-spinner' },
                'paid': { text: 'Đã TT', class: 'bg-green-100 text-green-700', icon: 'fa-check-circle' },
                'failed': { text: 'Thất bại', class: 'bg-red-100 text-red-700', icon: 'fa-times-circle' }
            };
            const info = statusMap[status] || statusMap['unpaid'];
            return `<span class="px-2 py-1 rounded-lg text-xs font-medium ${info.class}"><i class="fas ${info.icon} mr-1"></i>${info.text}</span>`;
        }

        function renderReservations(items) {
            const tbody = document.getElementById('reservations-tbody');
            if (items.length === 0) { 
                tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-12 text-center text-slate-500">Chưa có đặt bàn</td></tr>`; 
                return; 
            }
            
            tbody.innerHTML = items.map(res => {
                const itemCount = res.so_mon_da_dat || 0;
                const totalPrice = res.tong_tien_du_kien || 0;
                return `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 text-sm font-semibold text-slate-800">#${res.ma_dat_ban}</td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-slate-700">${res.ten_nguoi_dat}</div>
                        ${res.ten_nguoi_dung ? `<div class="text-xs text-blue-600"><i class="fas fa-user-circle mr-1"></i>${res.ten_nguoi_dung}</div>` : ''}
                    </td>
                    <td class="px-6 py-4 text-sm"><div class="text-slate-700">${res.so_dien_thoai}</div></td>
                    <td class="px-6 py-4 text-sm text-slate-700">${new Date(res.ngay_dat).toLocaleDateString('vi-VN')}</td>
                    <td class="px-6 py-4 text-sm font-semibold text-blue-600">${res.gio_den}</td>
                    <td class="px-6 py-4 text-sm text-slate-700">${res.so_luong} người</td>
                    <td class="px-6 py-4">
                        ${itemCount > 0 ? `
                            <div class="text-sm">
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded-lg font-medium">${itemCount} món</span>
                                <div class="text-xs text-gray-500 mt-1">${formatPrice(totalPrice)}</div>
                            </div>
                        ` : `<span class="text-xs text-gray-400">Chưa đặt món</span>`}
                    </td>
                    <td class="px-6 py-4">
                        ${getPaymentStatusBadge(res.trang_thai_thanh_toan)}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            <button onclick="updateStatus(${res.ma_dat_ban}, 'pending')" 
                                class="px-2 py-1 rounded-lg text-xs font-medium transition-all ${res.trang_thai === 'pending' ? 'bg-amber-500 text-white' : 'bg-amber-100 text-amber-700 hover:bg-amber-200'}" 
                                title="Chờ xác nhận"><i class="fas fa-clock"></i></button>
                            <button onclick="updateStatus(${res.ma_dat_ban}, 'confirmed')" 
                                class="px-2 py-1 rounded-lg text-xs font-medium transition-all ${res.trang_thai === 'confirmed' ? 'bg-blue-500 text-white' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}" 
                                title="Đã xác nhận"><i class="fas fa-check"></i></button>
                            <button onclick="updateStatus(${res.ma_dat_ban}, 'attended')" 
                                class="px-2 py-1 rounded-lg text-xs font-medium transition-all ${res.trang_thai === 'attended' ? 'bg-emerald-500 text-white' : 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200'}" 
                                title="Đã xác nhận (Admin)"><i class="fas fa-user-check"></i></button>
                            <button onclick="updateStatus(${res.ma_dat_ban}, 'cancelled')" 
                                class="px-2 py-1 rounded-lg text-xs font-medium transition-all ${res.trang_thai === 'cancelled' ? 'bg-red-500 text-white' : 'bg-red-100 text-red-700 hover:bg-red-200'}" 
                                title="Đã hủy"><i class="fas fa-times"></i></button>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="viewDetail(${res.ma_dat_ban})" class="text-blue-600 hover:text-blue-800 p-2" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        async function updateStatus(id, newStatus) {
            try {
                const response = await fetch(`${API_URL}/reservations/${id}/status`, { 
                    method: 'PUT', 
                    credentials: 'include', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ trang_thai: newStatus }) 
                });
                const result = await response.json();
                if (result.success) { 
                    const statusText = {
                        'pending': 'Chờ xác nhận',
                        'confirmed': 'Đã xác nhận',
                        'attended': 'Đã xác nhận (Admin)',
                        'cancelled': 'Đã hủy'
                    };
                    showNotification(`Cập nhật trạng thái thành "${statusText[newStatus]}" thành công!`, 'success');
                    loadReservations(); 
                } else {
                    showNotification('Lỗi: ' + result.message, 'error');
                }
            } catch (error) { 
                console.error('Error:', error); 
                showNotification('Có lỗi xảy ra khi cập nhật trạng thái', 'error'); 
            }
        }

        async function viewDetail(id) {
            try {
                const response = await fetch(`${API_URL}/reservations/${id}`, { credentials: 'include' });
                const result = await response.json();
                
                if (result.success) {
                    currentReservation = result.data;
                    showDetailModal(result.data);
                } else {
                    showNotification('Không thể tải chi tiết đặt bàn', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Có lỗi xảy ra', 'error');
            }
        }

        function showDetailModal(res) {
            document.getElementById('modal-id').textContent = `#${res.ma_dat_ban}`;
            document.getElementById('modal-name').textContent = res.ten_nguoi_dat;
            document.getElementById('modal-phone').textContent = res.so_dien_thoai;
            document.getElementById('modal-user').textContent = res.ten_nguoi_dung || res.nguoi_dung_email || 'Khách vãng lai';
            document.getElementById('modal-created').textContent = new Date(res.thoi_gian_tao).toLocaleString('vi-VN');
            
            document.getElementById('modal-date').textContent = new Date(res.ngay_dat).toLocaleDateString('vi-VN');
            document.getElementById('modal-time').textContent = res.gio_den;
            document.getElementById('modal-guests').textContent = `${res.so_luong} người`;
            
            const statusMap = {
                'pending': { text: 'Chờ xác nhận', class: 'text-amber-600' },
                'confirmed': { text: 'Đã xác nhận', class: 'text-blue-600' },
                'attended': { text: 'Đã xác nhận (Admin)', class: 'text-emerald-600' },
                'cancelled': { text: 'Đã hủy', class: 'text-red-600' }
            };
            const status = statusMap[res.trang_thai] || statusMap['pending'];
            document.getElementById('modal-status').textContent = status.text;
            document.getElementById('modal-status').className = `font-bold ${status.class}`;
            
            // Payment status
            const paymentStatusMap = {
                'unpaid': { text: 'Chưa thanh toán', class: 'text-gray-600' },
                'pending': { text: 'Đang xử lý', class: 'text-yellow-600' },
                'paid': { text: 'Đã thanh toán', class: 'text-green-600' },
                'failed': { text: 'Thất bại', class: 'text-red-600' }
            };
            const paymentStatus = paymentStatusMap[res.trang_thai_thanh_toan] || paymentStatusMap['unpaid'];
            document.getElementById('modal-payment-status').textContent = paymentStatus.text;
            document.getElementById('modal-payment-status').className = `font-bold ${paymentStatus.class}`;
            
            const noteDiv = document.getElementById('modal-note');
            if (res.ghi_chu) {
                document.getElementById('modal-note-text').textContent = res.ghi_chu;
                noteDiv.classList.remove('hidden');
            } else {
                noteDiv.classList.add('hidden');
            }
            
            const items = res.mon_an || [];
            document.getElementById('modal-items-count').textContent = `${items.length} món`;
            
            const itemsList = document.getElementById('modal-items-list');
            if (items.length > 0) {
                itemsList.innerHTML = items.map(item => {
                    let imagePath = item.anh_mon || '/images/placeholder.jpg';
                    if (imagePath && !imagePath.startsWith('/') && !imagePath.startsWith('http')) {
                        imagePath = '/images/' + imagePath;
                    }
                    const imageUrl = imagePath.startsWith('http') ? imagePath : `${API_URL.replace('/api', '')}${imagePath}`;
                    
                    return `
                        <div class="flex items-center gap-3 p-3 bg-orange-50 rounded-xl">
                            <img src="${imageUrl}" alt="${item.ten_mon}" 
                                 class="w-14 h-14 rounded-lg object-cover"
                                 onerror="this.src='../images/placeholder.svg'">
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-gray-800">${item.ten_mon}</p>
                                <p class="text-sm text-gray-500">SL: ${item.so_luong} x ${formatPrice(item.gia_tai_thoi_diem)}</p>
                            </div>
                            <p class="font-bold text-orange-600">${formatPrice(item.so_luong * item.gia_tai_thoi_diem)}</p>
                        </div>
                    `;
                }).join('');
            } else {
                itemsList.innerHTML = `
                    <div class="text-center py-6 text-gray-400">
                        <i class="fas fa-utensils text-3xl mb-2 opacity-50"></i>
                        <p>Chưa đặt món trước</p>
                    </div>
                `;
            }
            
            document.getElementById('modal-total').textContent = formatPrice(res.tong_tien_du_kien || 0);
            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
            currentReservation = null;
        }

        function printReservation() {
            if (!currentReservation) return;
            const res = currentReservation;
            const items = res.mon_an || [];
            
            const printContent = `
                <html>
                <head>
                    <title>Phiếu đặt bàn #${res.ma_dat_ban}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #ea580c; }
                        .info { margin: 20px 0; }
                        .info p { margin: 5px 0; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background: #f5f5f5; }
                        .total { text-align: right; font-size: 18px; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>PHIẾU ĐẶT BÀN #${res.ma_dat_ban}</h1>
                    <div class="info">
                        <p><strong>Khách hàng:</strong> ${res.ten_nguoi_dat}</p>
                        <p><strong>SĐT:</strong> ${res.so_dien_thoai}</p>
                        <p><strong>Ngày đến:</strong> ${new Date(res.ngay_dat).toLocaleDateString('vi-VN')}</p>
                        <p><strong>Giờ đến:</strong> ${res.gio_den}</p>
                        <p><strong>Số khách:</strong> ${res.so_luong} người</p>
                        ${res.ghi_chu ? `<p><strong>Ghi chú:</strong> ${res.ghi_chu}</p>` : ''}
                    </div>
                    ${items.length > 0 ? `
                        <h3>Món đặt trước:</h3>
                        <table>
                            <tr><th>Món</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th></tr>
                            ${items.map(item => `
                                <tr>
                                    <td>${item.ten_mon}</td>
                                    <td>${item.so_luong}</td>
                                    <td>${formatPrice(item.gia_tai_thoi_diem)}</td>
                                    <td>${formatPrice(item.so_luong * item.gia_tai_thoi_diem)}</td>
                                </tr>
                            `).join('')}
                        </table>
                        <p class="total">Tổng dự kiến: ${formatPrice(res.tong_tien_du_kien || 0)}</p>
                    ` : '<p><em>Chưa đặt món trước</em></p>'}
                    <p style="text-align: center; margin-top: 30px; color: #666;">In lúc: ${new Date().toLocaleString('vi-VN')}</p>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function applyFilters() {
            const search = document.getElementById('search').value.toLowerCase();
            const status = document.getElementById('status-filter').value;
            let filtered = reservations.filter(r => {
                const matchSearch = r.ten_nguoi_dat.toLowerCase().includes(search) || r.so_dien_thoai.includes(search);
                const matchStatus = !status || r.trang_thai === status;
                return matchSearch && matchStatus;
            });
            renderReservations(filtered);
        }

        // Close modal when clicking outside
        document.getElementById('detail-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                            type === 'error' ? 'bg-red-500' : 
                            type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
            const icon = type === 'success' ? 'fa-check-circle' : 
                         type === 'error' ? 'fa-exclamation-circle' : 
                         type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            notification.className = `fixed top-6 right-6 z-50 px-6 py-4 rounded-xl shadow-lg ${bgColor} text-white flex items-center gap-3 animate-slide-in`;
            notification.innerHTML = `
                <i class="fas ${icon} text-xl"></i>
                <span class="font-medium">${message}</span>
            `;
            notification.style.animation = 'slideIn 0.3s ease-out';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        loadReservations();
    </script>
</body>
</html>
