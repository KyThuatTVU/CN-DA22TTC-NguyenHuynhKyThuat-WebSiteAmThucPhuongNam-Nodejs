<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin Phương Nam</title>
    <link rel="icon" type="image/png" href="../images/Green Simple Clean Vegan Food Logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="admin-styles.css">
    <link rel="stylesheet" href="admin-responsive.css">
    <style>
        body { background: #f0f4f8; }
        .sidebar { background: linear-gradient(180deg, #1e3a5f 0%, #0f2744 100%); }
        .sidebar-item { color: #94a3b8; transition: all 0.2s; }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .sidebar-item.active { background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%); color: #fff; }
        .kpi-card { background: #fff; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(30,58,95,0.08); }
        .kpi-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; }
        .kpi-value { font-size: 2rem; font-weight: 700; color: #1e3a5f; }
        .kpi-label { font-size: 0.875rem; color: #64748b; margin-bottom: 4px; }
        .kpi-compare { font-size: 0.75rem; color: #64748b; }
        .kpi-compare .up { color: #10b981; }
        .kpi-compare .down { color: #ef4444; }
        .chart-card { background: #fff; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(30,58,95,0.08); }
        .chart-title { font-size: 1rem; font-weight: 600; color: #1e3a5f; margin-bottom: 20px; }
        .filter-section { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(30,58,95,0.08); }
        .filter-group { margin-bottom: 20px; }
        .filter-label { font-size: 0.75rem; font-weight: 600; color: #1e3a5f; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-btn { padding: 8px 14px; border-radius: 8px; font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: all 0.2s; border: 1px solid #e2e8f0; }
        .filter-btn.active { background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%); color: #fff; border-color: transparent; }
        .filter-btn:not(.active) { background: #f8fafc; color: #475569; }
        .filter-btn:hover:not(.active) { background: #e2e8f0; }
        .header-bar { background: linear-gradient(90deg, #1e3a5f 0%, #2d4a6f 100%); color: #fff; padding: 16px 28px; }
        .product-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
        .product-row:last-child { border-bottom: none; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #64748b; }
        .legend-dot { width: 12px; height: 12px; border-radius: 4px; }
        .admin-card { background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%); border-radius: 12px; padding: 16px; }
    </style>
</head>
<body>
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-72 flex-shrink-0 transition-all duration-300">
            <div class="h-full flex flex-col">
                <!-- Logo -->
                <div class="p-5 border-b border-white/10">
                    <div class="flex items-center space-x-3">
                        <img src="../images/Green Simple Clean Vegan Food Logo.png" alt="Logo" class="w-11 h-11 rounded-xl object-contain bg-white p-1">
                        <div>
                            <h1 class="font-bold text-white text-lg">Phương Nam</h1>
                            <p class="text-xs text-blue-300">Hệ thống quản trị</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 overflow-y-auto p-4">
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Menu chính</p>
                    <div class="space-y-1">
                        <a href="dashboard.html" class="sidebar-item active flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-chart-pie w-5"></i><span class="text-sm font-medium">Tổng quan</span>
                        </a>
                        <a href="products.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-utensils w-5"></i><span class="text-sm">Món ăn</span>
                        </a>
                        <a href="orders.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-shopping-cart w-5"></i><span class="text-sm">Đơn hàng</span>
                        </a>
                        <a href="reservations.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-calendar-check w-5"></i><span class="text-sm">Đặt bàn</span>
                        </a>
                        <a href="customers.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-users w-5"></i><span class="text-sm">Khách hàng</span>
                        </a>
                        <a href="contacts.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-envelope w-5"></i><span class="text-sm">Liên hệ</span>
                        </a>
                        <a href="chatbot-history.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-robot w-5"></i><span class="text-sm">Lịch sử Chatbot</span>
                        </a>
                        <a href="reviews.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-star w-5"></i><span class="text-sm">Đánh giá</span>
                        </a>
                    </div>
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-3">Nội dung</p>
                    <div class="space-y-1">
                        <a href="news.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-newspaper w-5"></i><span class="text-sm">Tin tức</span>
                        </a>
                        <a href="quan-ly-binh-luan.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-comments w-5"></i><span class="text-sm">Bình luận tin tức</span>
                        </a>
                        <a href="quan-ly-danh-gia-tin-tuc.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-thumbs-up w-5"></i><span class="text-sm">Reactions tin tức</span>
                        </a>
                        <a href="albums.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-images w-5"></i><span class="text-sm">Album ảnh</span>
                        </a>
                    </div>
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-3">Hệ thống</p>
                    <div class="space-y-1">
                        <a href="settings.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-cog w-5"></i><span class="text-sm">Cài đặt</span>
                        </a>
                    </div>
                </nav>

                <!-- Admin Profile Card -->
                <div class="p-4 border-t border-white/10">
                    <div class="admin-card">
                        <div class="flex items-center space-x-3">
                            <img id="admin-avatar" referrerpolicy="no-referrer" src="https://ui-avatars.com/api/?name=Admin&background=3b82f6&color=fff" alt="Admin" class="w-12 h-12 rounded-full border-2 border-blue-400">
                            <div class="flex-1 min-w-0">
                                <p id="admin-name" class="font-semibold text-sm text-white truncate">Đang tải...</p>
                                <p id="admin-email" class="text-xs text-blue-300 truncate">admin@example.com</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-3 pt-3 border-t border-white/20">
                            <span class="text-xs text-blue-300"><i class="fab fa-google mr-1"></i>Google Account</span>
                            <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300 transition flex items-center">
                                <i class="fas fa-sign-out-alt mr-1"></i>Đăng xuất
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Sidebar Overlay -->
            <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
            
            <!-- Header Bar -->
            <header class="header-bar flex items-center justify-between">
                <div class="flex items-center space-x-3 sm:space-x-4">
                    <button onclick="toggleSidebar()" class="mobile-menu-btn lg:hidden text-white"><i class="fas fa-bars text-xl"></i></button>
                    <div>
                        <h2 class="text-base sm:text-xl font-bold">Dashboard</h2>
                        <p class="text-xs sm:text-sm text-blue-200 hidden sm:block">Báo cáo tổng quan nhà hàng</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="relative text-white hover:text-blue-200 transition">
                        <i class="fas fa-bell text-lg"></i>
                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">3</span>
                    </button>
                    <a href="../index.html" target="_blank" class="text-white hover:text-blue-200 transition" title="Xem website">
                        <i class="fas fa-external-link-alt text-lg"></i>
                    </a>
                    <div class="hidden md:flex items-center space-x-3 pl-4 border-l border-white/20">
                        <img id="admin-avatar-header" referrerpolicy="no-referrer" src="https://ui-avatars.com/api/?name=Admin&background=3b82f6&color=fff" alt="Admin" class="w-10 h-10 rounded-full border-2 border-blue-400">
                        <div>
                            <p id="admin-name-header" class="font-semibold text-sm text-white">Admin</p>
                            <p class="text-xs text-blue-200">Quản trị viên</p>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="flex gap-6">
                    <!-- Main Content Area -->
                    <div class="flex-1">
                        <!-- KPI Cards -->
                        <div class="grid grid-cols-4 gap-5 mb-6">
                            <div class="kpi-card">
                                <div class="flex items-center gap-4">
                                    <div class="kpi-icon bg-slate-100">
                                        <i class="fas fa-coins text-slate-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="kpi-label">Tổng doanh thu</p>
                                        <p class="kpi-value" id="total-revenue">0đ</p>
                                        <p class="kpi-compare" id="revenue-compare">So với tháng trước: <span class="up"><i class="fas fa-arrow-up"></i> 0%</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card">
                                <div class="flex items-center gap-4">
                                    <div class="kpi-icon bg-slate-100">
                                        <i class="fas fa-receipt text-slate-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="kpi-label">Số đơn hàng</p>
                                        <p class="kpi-value" id="total-orders">0</p>
                                        <p class="kpi-compare" id="orders-compare">So với tháng trước: <span class="up"><i class="fas fa-arrow-up"></i> 0%</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card">
                                <div class="flex items-center gap-4">
                                    <div class="kpi-icon bg-slate-100">
                                        <i class="fas fa-user text-slate-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="kpi-label">Khách hàng</p>
                                        <p class="kpi-value" id="total-customers">0</p>
                                        <p class="kpi-compare" id="customers-compare">So với tháng trước: <span class="up"><i class="fas fa-arrow-up"></i> 0%</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card">
                                <div class="flex items-center gap-4">
                                    <div class="kpi-icon bg-slate-100">
                                        <i class="fas fa-calendar text-slate-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="kpi-label">Đặt bàn</p>
                                        <p class="kpi-value" id="total-reservations">0</p>
                                        <p class="kpi-compare" id="reservations-compare">So với tháng trước: <span class="up"><i class="fas fa-arrow-up"></i> 0%</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: 5 Mục tiêu tháng -->
                        <div class="chart-card mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <p class="chart-title mb-0"><i class="fas fa-target text-slate-600 mr-2"></i>5 Mục tiêu tháng <span id="goals-month-year"></span></p>
                                <div class="flex items-center gap-2">
                                    <span id="total-progress-badge" class="px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm font-bold">0%</span>
                                    <button onclick="generateGoals()" id="btn-generate-goals" class="px-3 py-1.5 bg-slate-700 text-white rounded-lg text-xs hover:bg-slate-800 transition">
                                        <i class="fas fa-plus mr-1"></i>AI Tạo mục tiêu
                                    </button>
                                    <button onclick="resetGoals()" id="btn-reset-goals" class="px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs hover:bg-slate-200 transition hidden" title="Xóa mục tiêu để tạo lại">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    <button onclick="refreshGoals()" class="px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs hover:bg-slate-200 transition">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="goals-container" class="grid grid-cols-5 gap-4">
                                <!-- Goals will be loaded here -->
                                <div class="col-span-5 text-center py-8 text-gray-400">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p class="text-sm">Đang tải mục tiêu...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: Gauge + Revenue Chart -->
                        <div class="grid grid-cols-3 gap-5 mb-6">
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-chart-pie text-slate-600 mr-2"></i>Tỷ lệ hoàn thành tổng</p>
                                <div style="height: 160px; position: relative;">
                                    <canvas id="gaugeChart"></canvas>
                                    <div style="position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); text-align: center;">
                                        <p class="text-3xl font-bold text-slate-700" id="gauge-value">0%</p>
                                        <p class="text-xs text-gray-500">Hoàn thành mục tiêu</p>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-card col-span-2">
                                <p class="chart-title"><i class="fas fa-chart-line text-slate-600 mr-2"></i>Doanh thu 12 tháng gần nhất</p>
                                <div style="height: 200px;"><canvas id="revenueChart"></canvas></div>
                                <div class="flex justify-center gap-8 mt-3">
                                    <div class="legend-item"><div class="legend-dot bg-slate-600"></div> Doanh thu (triệu đồng)</div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: Orders + Top Products + Customers -->
                        <div class="grid grid-cols-3 gap-5 mb-6">
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-chart-pie text-slate-600 mr-2"></i>Đơn hàng theo trạng thái</p>
                                <div style="height: 200px;"><canvas id="ordersChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-star text-slate-600 mr-2"></i>Top 10 món ăn bán chạy</p>
                                <div id="top-products" class="space-y-2" style="max-height: 220px; overflow-y: auto;"></div>
                            </div>
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-users text-slate-600 mr-2"></i>Khách hàng mới theo tháng</p>
                                <div style="height: 200px;"><canvas id="customerChart"></canvas></div>
                            </div>
                        </div>

                        <!-- Row 4: Reservations + Payment Methods + Recent Orders -->
                        <div class="grid grid-cols-3 gap-5 mb-6">
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-clock text-slate-600 mr-2"></i>Đặt bàn theo khung giờ</p>
                                <div style="height: 200px;"><canvas id="reservationChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-wallet text-slate-600 mr-2"></i>Phương thức thanh toán</p>
                                <div style="height: 200px;"><canvas id="paymentMethodsChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-list text-slate-600 mr-2"></i>Đơn hàng gần đây</p>
                                <div id="recent-orders" class="space-y-2" style="max-height: 220px; overflow-y: auto;"></div>
                            </div>
                        </div>

                        <!-- Row 5: Reviews Stats -->
                        <div class="grid grid-cols-3 gap-5 mb-6">
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-star text-slate-600 mr-2"></i>Phân bố đánh giá sao</p>
                                <div style="height: 180px;"><canvas id="reviewStarChart"></canvas></div>
                                <div class="text-center mt-2">
                                    <p class="text-sm text-slate-500">Điểm trung bình</p>
                                    <p class="text-2xl font-bold text-slate-700" id="avg-rating">0.0 <i class="fas fa-star text-lg"></i></p>
                                </div>
                            </div>
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-chart-pie text-slate-600 mr-2"></i>Trạng thái đánh giá</p>
                                <div style="height: 200px;"><canvas id="reviewStatusChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <div class="flex items-center justify-between mb-4">
                                    <p class="chart-title mb-0"><i class="fas fa-award text-slate-600 mr-2"></i>Top món được đánh giá</p>
                                    <a href="reviews.html" class="text-xs text-slate-600 hover:text-slate-800">Xem tất cả <i class="fas fa-arrow-right"></i></a>
                                </div>
                                <div id="top-reviewed-products" class="space-y-2" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>

                        <!-- Row 6: News Stats -->
                        <div class="grid grid-cols-3 gap-5">
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-newspaper text-slate-600 mr-2"></i>Lượt xem bài viết theo tháng</p>
                                <div style="height: 200px;"><canvas id="newsViewsChart"></canvas></div>
                            </div>
                            <div class="chart-card col-span-2">
                                <div class="flex items-center justify-between mb-4">
                                    <p class="chart-title mb-0"><i class="fas fa-eye text-slate-600 mr-2"></i>Top bài viết được xem nhiều nhất</p>
                                    <div class="flex items-center space-x-4 text-sm">
                                        <span class="text-slate-500">Tổng: <span id="total-news" class="font-bold text-slate-700">0</span> bài</span>
                                        <span class="text-slate-500">Lượt xem: <span id="total-views" class="font-bold text-slate-700">0</span></span>
                                    </div>
                                </div>
                                <div id="top-news" class="space-y-2" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Sidebar -->
                    <div class="w-52 flex-shrink-0">
                        <div class="filter-section sticky top-0">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-bold text-slate-700 uppercase">Bộ lọc</h3>
                                <button onclick="resetFilters()" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                                    <i class="fas fa-redo mr-1"></i>Reset
                                </button>
                            </div>
                            
                            <div class="filter-group">
                                <p class="filter-label">Năm</p>
                                <div class="flex flex-wrap gap-2">
                                    <button class="filter-btn" data-year="2023">2023</button>
                                    <button class="filter-btn" data-year="2024">2024</button>
                                    <button class="filter-btn active" data-year="2025">2025</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <p class="filter-label">Tháng</p>
                                <div class="grid grid-cols-4 gap-2">
                                    <button class="filter-btn active" data-month="0">All</button>
                                    <button class="filter-btn" data-month="1">1</button>
                                    <button class="filter-btn" data-month="2">2</button>
                                    <button class="filter-btn" data-month="3">3</button>
                                    <button class="filter-btn" data-month="4">4</button>
                                    <button class="filter-btn" data-month="5">5</button>
                                    <button class="filter-btn" data-month="6">6</button>
                                    <button class="filter-btn" data-month="7">7</button>
                                    <button class="filter-btn" data-month="8">8</button>
                                    <button class="filter-btn" data-month="9">9</button>
                                    <button class="filter-btn" data-month="10">10</button>
                                    <button class="filter-btn" data-month="11">11</button>
                                    <button class="filter-btn" data-month="12">12</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <p class="filter-label">Trạng thái đơn</p>
                                <div class="flex flex-col gap-2">
                                    <button class="filter-btn active" data-status="all">Tất cả</button>
                                    <button class="filter-btn" data-status="pending">Chờ xử lý</button>
                                    <button class="filter-btn" data-status="confirmed">Đã xác nhận</button>
                                    <button class="filter-btn" data-status="delivered">Hoàn thành</button>
                                    <button class="filter-btn" data-status="cancelled">Đã hủy</button>
                                </div>
                            </div>
                            
                            <!-- Filter Summary -->
                            <div id="filter-summary" class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200 text-xs">
                                <p class="font-semibold text-blue-800 mb-1">Đang xem:</p>
                                <p class="text-blue-700" id="filter-summary-text">Tất cả dữ liệu năm 2025</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="check-auth.js"></script>
    <script src="admin-layout.js"></script>
    <script src="admin-mobile.js"></script>

    <script>
        // API_URL đã được khai báo trong admin-layout.js
        const API_BASE = API_URL; // Alias để tương thích
        let gaugeChart, revenueChart, ordersChart, customerChart, reservationChart, newsViewsChart, reviewStarChart, reviewStatusChart, paymentMethodsChart;
        
        document.addEventListener('DOMContentLoaded', function() {
            initAllCharts();
            loadDashboardData();
            initFilters();
            
            // Hiển thị filter summary ban đầu
            const initialFilters = getFilterValues();
            updateFilterSummary(initialFilters);
        });

        function initAllCharts() {
            // Gauge Chart
            gaugeChart = new Chart(document.getElementById('gaugeChart').getContext('2d'), {
                type: 'doughnut',
                data: { datasets: [{ data: [0, 100], backgroundColor: ['#475569', '#e2e8f0'], borderWidth: 0, circumference: 180, rotation: 270 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });

            // Revenue Chart - khởi tạo với dữ liệu rỗng, sẽ load từ API
            revenueChart = new Chart(document.getElementById('revenueChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
                    datasets: [
                        { label: 'Doanh thu', data: new Array(12).fill(0), backgroundColor: '#475569', borderRadius: 6, barPercentage: 0.6 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => v + 'tr' } } } }
            });

            // Orders Chart
            ordersChart = new Chart(document.getElementById('ordersChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Hoàn thành', 'Đang xử lý', 'Chờ xác nhận', 'Đã hủy'], datasets: [{ data: [65, 20, 10, 5], backgroundColor: ['#334155', '#475569', '#64748b', '#94a3b8'], borderWidth: 3, borderColor: '#fff' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } } } }
            });

            // Customer Chart - khởi tạo với dữ liệu rỗng, sẽ load từ API
            customerChart = new Chart(document.getElementById('customerChart').getContext('2d'), {
                type: 'line',
                data: { labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'], datasets: [{ label: 'Khách mới', data: new Array(12).fill(0), borderColor: '#475569', backgroundColor: 'rgba(71, 85, 105, 0.1)', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 5, pointBackgroundColor: '#475569', pointBorderColor: '#fff', pointBorderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#f1f5f9' } } } }
            });

            // Reservation Chart - khởi tạo với dữ liệu rỗng, sẽ load từ API
            reservationChart = new Chart(document.getElementById('reservationChart').getContext('2d'), {
                type: 'bar',
                data: { labels: ['10-12h', '12-14h', '14-16h', '16-18h', '18-20h', '20-22h'], datasets: [{ label: 'Số lượt đặt', data: new Array(6).fill(0), backgroundColor: '#64748b', borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#f1f5f9' } } } }
            });

            // News Views Chart
            newsViewsChart = new Chart(document.getElementById('newsViewsChart').getContext('2d'), {
                type: 'line',
                data: { 
                    labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'], 
                    datasets: [{ 
                        label: 'Lượt xem', 
                        data: new Array(12).fill(0), 
                        borderColor: '#64748b', 
                        backgroundColor: 'rgba(100, 116, 139, 0.1)', 
                        borderWidth: 3, 
                        fill: true, 
                        tension: 0.4, 
                        pointRadius: 5, 
                        pointBackgroundColor: '#64748b', 
                        pointBorderColor: '#fff', 
                        pointBorderWidth: 2 
                    }] 
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#f1f5f9' } } } }
            });

            // Review Star Distribution Chart
            reviewStarChart = new Chart(document.getElementById('reviewStarChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['5 sao', '4 sao', '3 sao', '2 sao', '1 sao'],
                    datasets: [{
                        label: 'Số lượng',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#334155', '#475569', '#64748b', '#94a3b8', '#cbd5e1'],
                        borderRadius: 6,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, grid: { display: false } },
                        y: { grid: { display: false } }
                    }
                }
            });

            // Review Status Chart
            reviewStatusChart = new Chart(document.getElementById('reviewStatusChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Đã duyệt', 'Chờ duyệt', 'Đã khóa'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#475569', '#94a3b8', '#cbd5e1'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } }
                    }
                }
            });

            // Payment Methods Chart
            paymentMethodsChart = new Chart(document.getElementById('paymentMethodsChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Tiền mặt', 'MoMo', 'Chuyển khoản'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#475569', '#64748b', '#94a3b8'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} đơn (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadDashboardData() {
            try {
                // Lấy filter hiện tại (mặc định năm 2025)
                const filters = getFilterValues();
                const yearParam = `?year=${filters.year || 2025}`;
                
                // Load tất cả dữ liệu song song với filter năm
                const [ordersRes, customersRes, reservationsRes, revenueMonthlyRes, customersMonthlyRes, reservationsByTimeRes, newsViewsRes, newsViewsMonthlyRes, reviewsRes] = await Promise.all([
                    fetch(`${API_BASE}/orders/stats${yearParam}`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/customers/stats`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/reservations/stats`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/revenue-monthly${yearParam}`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/customers-monthly${yearParam}`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/reservations-by-time${yearParam}`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/news-views`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/news-views-monthly${yearParam}`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/reviews/admin/all`, { credentials: 'include' }).catch(() => null)
                ]);

                // KPI Cards
                if (ordersRes && ordersRes.ok) {
                    const data = await ordersRes.json();
                    if (data.success !== false) {
                        document.getElementById('total-revenue').textContent = formatCurrency(data.totalRevenue || 0) + 'đ';
                        document.getElementById('total-orders').textContent = data.totalOrders || 0;
                        updateGaugeChart(data.totalRevenue || 0, 100000000);
                        updateOrdersChart(data.byStatus || []);
                        
                        // Cập nhật so sánh với tháng trước từ dữ liệu thật
                        if (data.comparison) {
                            updateComparisonDisplay('revenue-compare', data.comparison.revenueChange);
                            updateComparisonDisplay('orders-compare', data.comparison.ordersChange);
                        }
                    }
                }

                if (customersRes && customersRes.ok) {
                    const data = await customersRes.json();
                    if (data.success !== false) {
                        document.getElementById('total-customers').textContent = data.totalCustomers || 0;
                        if (data.comparison) {
                            updateComparisonDisplay('customers-compare', data.comparison.customersChange);
                        }
                    }
                }

                if (reservationsRes && reservationsRes.ok) {
                    const data = await reservationsRes.json();
                    if (data.success !== false) {
                        document.getElementById('total-reservations').textContent = data.totalReservations || 0;
                        if (data.comparison) {
                            updateComparisonDisplay('reservations-compare', data.comparison.reservationsChange);
                        }
                    }
                }

                // Load customers và reservations stats riêng (không filter được vì là tổng số)
                await loadCustomersAndReservationsStats();

                // Biểu đồ doanh thu theo tháng
                if (revenueMonthlyRes && revenueMonthlyRes.ok) {
                    const data = await revenueMonthlyRes.json();
                    if (data.success && data.data) {
                        updateRevenueChart(data.data);
                    }
                }

                // Biểu đồ khách hàng mới theo tháng
                if (customersMonthlyRes && customersMonthlyRes.ok) {
                    const data = await customersMonthlyRes.json();
                    if (data.success && data.data) {
                        updateCustomerChart(data.data);
                    }
                }

                // Biểu đồ đặt bàn theo khung giờ
                if (reservationsByTimeRes && reservationsByTimeRes.ok) {
                    const data = await reservationsByTimeRes.json();
                    if (data.success && data.data) {
                        updateReservationChart(data.data);
                    }
                }

                // Top bài viết và tổng lượt xem
                if (newsViewsRes && newsViewsRes.ok) {
                    const data = await newsViewsRes.json();
                    if (data.success) {
                        document.getElementById('total-news').textContent = data.totalNews || 0;
                        document.getElementById('total-views').textContent = formatNumber(data.totalViews || 0);
                        renderTopNews(data.data || []);
                    }
                }

                // Biểu đồ lượt xem tin tức theo tháng
                if (newsViewsMonthlyRes && newsViewsMonthlyRes.ok) {
                    const data = await newsViewsMonthlyRes.json();
                    if (data.success && data.data) {
                        updateNewsViewsChart(data.data);
                    }
                }

                // Thống kê đánh giá
                if (reviewsRes && reviewsRes.ok) {
                    const data = await reviewsRes.json();
                    if (data.success) {
                        updateReviewCharts(data.stats, data.topProducts);
                    }
                }

                // Load payment methods stats với filter năm
                const paymentMethodsRes2 = await fetch(`${API_BASE}/stats/payment-methods${yearParam}`, { credentials: 'include' }).catch(() => null);
                if (paymentMethodsRes2 && paymentMethodsRes2.ok) {
                    const data = await paymentMethodsRes2.json();
                    if (data.success && data.data) {
                        updatePaymentMethodsChart(data.data);
                    }
                }

                // Load top products và recent orders
                await renderTopProducts();
                await renderRecentOrders();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                await renderTopProducts();
                await renderRecentOrders();
            }
        }

        function updateRevenueChart(data) {
            // Tạo mảng 12 tháng với giá trị 0
            const monthlyData = new Array(12).fill(0);
            // Lấy năm từ filter hiện tại, mặc định 2025 (năm có dữ liệu)
            const filters = getFilterValues();
            const targetYear = filters.year || 2025;
            
            data.forEach(item => {
                if (item.nam === targetYear && item.thang >= 1 && item.thang <= 12) {
                    monthlyData[item.thang - 1] = Math.round((item.doanh_thu || 0) / 1000000); // Chuyển sang triệu
                }
            });

            revenueChart.data.datasets[0].data = monthlyData;
            revenueChart.update();
        }

        function updateCustomerChart(data) {
            const monthlyData = new Array(12).fill(0);
            // Lấy năm từ filter hiện tại, mặc định 2025 (năm có dữ liệu)
            const filters = getFilterValues();
            const targetYear = filters.year || 2025;
            
            data.forEach(item => {
                if (item.nam === targetYear && item.thang >= 1 && item.thang <= 12) {
                    monthlyData[item.thang - 1] = item.so_luong || 0;
                }
            });

            customerChart.data.datasets[0].data = monthlyData;
            customerChart.update();
        }

        function updateReservationChart(data) {
            const timeSlots = ['10-12h', '12-14h', '14-16h', '16-18h', '18-20h', '20-22h'];
            const slotData = timeSlots.map(slot => {
                const found = data.find(d => d.khung_gio === slot);
                return found ? found.so_luong : 0;
            });

            reservationChart.data.datasets[0].data = slotData;
            reservationChart.update();
        }

        function updateNewsViewsChart(data) {
            const monthlyData = new Array(12).fill(0);
            // Lấy năm từ filter hiện tại, mặc định 2025 (năm có dữ liệu)
            const filters = getFilterValues();
            const targetYear = filters.year || 2025;
            
            data.forEach(item => {
                if (item.nam === targetYear && item.thang >= 1 && item.thang <= 12) {
                    monthlyData[item.thang - 1] = item.tong_luot_xem || 0;
                }
            });

            newsViewsChart.data.datasets[0].data = monthlyData;
            newsViewsChart.update();
        }

        function updateReviewCharts(stats, topProducts) {
            // Update star distribution chart
            if (stats && stats.starDistribution && reviewStarChart) {
                const dist = stats.starDistribution;
                reviewStarChart.data.datasets[0].data = [dist[5] || 0, dist[4] || 0, dist[3] || 0, dist[2] || 0, dist[1] || 0];
                reviewStarChart.update();
            }

            // Update average rating
            const avgRating = parseFloat(stats?.average_rating || 0).toFixed(1);
            document.getElementById('avg-rating').innerHTML = `${avgRating} <i class="fas fa-star text-lg"></i>`;

            // Update status chart
            if (stats && reviewStatusChart) {
                reviewStatusChart.data.datasets[0].data = [stats.approved || 0, stats.pending || 0, stats.rejected || 0];
                reviewStatusChart.update();
            }

            // Render top reviewed products
            renderTopReviewedProducts(topProducts);
        }

        function renderTopReviewedProducts(products) {
            const container = document.getElementById('top-reviewed-products');
            if (!products || products.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Chưa có dữ liệu</p>';
                return;
            }

            const maxCount = Math.max(...products.map(p => p.review_count || 0));
            container.innerHTML = products.map((p, i) => {
                const avgRating = parseFloat(p.avg_rating || 0).toFixed(1);
                return `
                    <div class="product-row">
                        <span class="w-7 h-7 rounded-full bg-gradient-to-br from-yellow-500 to-orange-500 text-white text-xs font-bold flex items-center justify-center mr-3">${i + 1}</span>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-800 truncate" title="${p.ten_mon}">${p.ten_mon}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <div class="flex-1 bg-slate-100 rounded-full h-2">
                                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 h-2 rounded-full" style="width: ${maxCount > 0 ? (p.review_count/maxCount)*100 : 0}%"></div>
                                </div>
                                <span class="text-xs text-yellow-600"><i class="fas fa-star"></i> ${avgRating}</span>
                            </div>
                        </div>
                        <span class="text-sm font-semibold text-orange-600 ml-2">${p.review_count}</span>
                    </div>
                `;
            }).join('');
        }

        function renderTopNews(newsData) {
            const container = document.getElementById('top-news');
            if (!newsData || newsData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Chưa có bài viết</p>';
                return;
            }
            const maxViews = Math.max(...newsData.map(n => n.luot_xem || 0));
            container.innerHTML = newsData.map((news, i) => `
                <div class="product-row">
                    <span class="w-7 h-7 rounded-full bg-slate-600 text-white text-xs font-bold flex items-center justify-center mr-3">${i + 1}</span>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800 truncate" title="${news.tieu_de}">${news.tieu_de}</p>
                        <div class="w-full bg-slate-100 rounded-full h-2 mt-1">
                            <div class="bg-slate-600 h-2 rounded-full transition-all" style="width: ${maxViews > 0 ? (news.luot_xem/maxViews)*100 : 0}%"></div>
                        </div>
                    </div>
                    <span class="text-sm font-semibold text-slate-700 ml-3">${formatNumber(news.luot_xem || 0)}</span>
                </div>
            `).join('');
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function updateGaugeChart(actual, target) {
            const percentage = Math.min(100, Math.round((actual / target) * 100));
            gaugeChart.data.datasets[0].data = [percentage, 100 - percentage];
            gaugeChart.update();
            document.getElementById('gauge-value').textContent = percentage + '%';
        }

        function updateOrdersChart(statusData) {
            const statusMap = { delivered: 0, preparing: 0, confirmed: 0, pending: 0, cancelled: 0 };
            statusData.forEach(s => { statusMap[s.trang_thai] = s.count; });
            ordersChart.data.datasets[0].data = [statusMap.delivered, statusMap.preparing + statusMap.confirmed, statusMap.pending, statusMap.cancelled];
            ordersChart.update();
        }

        async function renderTopProducts() {
            const container = document.getElementById('top-products');
            try {
                // Lấy filter hiện tại
                const filters = getFilterValues();
                const yearParam = `?year=${filters.year || 2025}`;
                const response = await fetch(`${API_BASE}/stats/top-products${yearParam}`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.length > 0) {
                        const products = data.data;
                        const maxSold = Math.max(...products.map(p => p.da_ban || 0));
                        container.innerHTML = products.map((p, i) => `
                            <div class="product-row">
                                <span class="w-7 h-7 rounded-full bg-slate-600 text-white text-xs font-bold flex items-center justify-center mr-3">${i + 1}</span>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-800 truncate">${p.ten_mon}</p>
                                    <div class="w-full bg-slate-100 rounded-full h-2 mt-1">
                                        <div class="bg-slate-600 h-2 rounded-full transition-all" style="width: ${maxSold > 0 ? (p.da_ban/maxSold)*100 : 0}%"></div>
                                    </div>
                                </div>
                                <span class="text-sm font-semibold text-slate-700 ml-3">${p.da_ban || 0}</span>
                            </div>
                        `).join('');
                        return;
                    }
                }
            } catch (error) {
                console.error('Error loading top products:', error);
            }
            container.innerHTML = '<p class="text-center text-gray-500 py-4">Chưa có dữ liệu</p>';
        }

        async function renderRecentOrders() {
            const container = document.getElementById('recent-orders');
            const statusColors = { delivered: 'bg-emerald-100 text-emerald-700', confirmed: 'bg-blue-100 text-blue-700', preparing: 'bg-blue-100 text-blue-700', pending: 'bg-amber-100 text-amber-700', cancelled: 'bg-red-100 text-red-700' };
            const statusText = { delivered: 'Hoàn thành', confirmed: 'Đã xác nhận', preparing: 'Đang chuẩn bị', pending: 'Chờ xác nhận', cancelled: 'Đã hủy' };
            
            try {
                const response = await fetch(`${API_BASE}/orders/all?limit=5`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(o => `
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition">
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-800">#DH${String(o.ma_don_hang).padStart(6, '0')} - ${o.ten_khach_hang || o.ten_khach_vang_lai || 'Khách hàng'}</p>
                                    <p class="text-xs text-gray-500 mt-0.5">${formatTimeAgo(o.thoi_gian_tao)}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-bold text-blue-600">${formatCurrency(o.tong_tien || 0)}đ</p>
                                    <span class="text-xs px-2 py-1 rounded-full ${statusColors[o.trang_thai] || 'bg-gray-100 text-gray-700'} font-medium">${statusText[o.trang_thai] || o.trang_thai}</span>
                                </div>
                            </div>
                        `).join('');
                        return;
                    }
                }
            } catch (error) {
                console.error('Error loading recent orders:', error);
            }
            container.innerHTML = '<p class="text-center text-gray-500 py-4">Chưa có đơn hàng</p>';
        }

        function formatTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Vừa xong';
            if (diffMins < 60) return `${diffMins} phút trước`;
            if (diffHours < 24) return `${diffHours} giờ trước`;
            if (diffDays < 7) return `${diffDays} ngày trước`;
            return date.toLocaleDateString('vi-VN');
        }

        function formatCurrency(value) { return new Intl.NumberFormat('vi-VN').format(value); }

        async function loadCustomersAndReservationsStats() {
            try {
                const [customersRes, reservationsRes] = await Promise.all([
                    fetch(`${API_BASE}/customers/stats`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/reservations/stats`, { credentials: 'include' }).catch(() => null)
                ]);

                if (customersRes && customersRes.ok) {
                    const data = await customersRes.json();
                    if (data.success !== false) {
                        document.getElementById('total-customers').textContent = data.totalCustomers || 0;
                        if (data.comparison) {
                            updateComparisonDisplay('customers-compare', data.comparison.customersChange);
                        }
                    }
                }

                if (reservationsRes && reservationsRes.ok) {
                    const data = await reservationsRes.json();
                    if (data.success !== false) {
                        document.getElementById('total-reservations').textContent = data.totalReservations || 0;
                        if (data.comparison) {
                            updateComparisonDisplay('reservations-compare', data.comparison.reservationsChange);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading customers/reservations stats:', error);
            }
        }

        // Hàm cập nhật hiển thị so sánh với tháng trước
        function updateComparisonDisplay(elementId, changePercent) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const isPositive = changePercent >= 0;
            const icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
            const colorClass = isPositive ? 'up' : 'down';
            const displayValue = Math.abs(changePercent).toFixed(1);
            
            element.innerHTML = `So với tháng trước: <span class="${colorClass}"><i class="fas ${icon}"></i> ${displayValue}%</span>`;
        }

        // Lấy giá trị filter hiện tại
        function getFilterValues() {
            const yearBtn = document.querySelector('.filter-btn[data-year].active');
            const monthBtn = document.querySelector('.filter-btn[data-month].active');
            const statusBtn = document.querySelector('.filter-btn[data-status].active');
            
            return {
                year: yearBtn ? parseInt(yearBtn.dataset.year) : new Date().getFullYear(),
                month: monthBtn ? parseInt(monthBtn.dataset.month) : 0, // 0 = All
                status: statusBtn ? statusBtn.dataset.status : 'all'
            };
        }

        function initFilters() {
            document.querySelectorAll('.filter-group').forEach(group => {
                group.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // Không cho click lại nút đang active
                        if (this.classList.contains('active')) return;
                        
                        group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Hiển thị loading state
                        showFilterLoading();
                        
                        // Lấy filter values và load lại data
                        const filters = getFilterValues();
                        console.log('Filters changed:', filters);
                        loadDashboardDataWithFilters(filters).finally(() => {
                            hideFilterLoading();
                            updateFilterSummary(filters);
                        });
                    });
                });
            });
        }

        function showFilterLoading() {
            // Thêm overlay loading nhẹ
            const mainContent = document.querySelector('main');
            if (mainContent && !document.getElementById('filter-loading-overlay')) {
                const overlay = document.createElement('div');
                overlay.id = 'filter-loading-overlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); z-index: 40; display: flex; align-items: center; justify-content: center;';
                overlay.innerHTML = '<div style="background: white; padding: 20px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);"><i class="fas fa-spinner fa-spin text-3xl text-blue-600 mb-2"></i><p class="text-sm text-slate-600 mt-2">Đang tải dữ liệu...</p></div>';
                document.body.appendChild(overlay);
            }
        }

        function hideFilterLoading() {
            const overlay = document.getElementById('filter-loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function resetFilters() {
            // Reset về mặc định: năm 2025 (năm có dữ liệu), tháng All, trạng thái All
            const defaultYear = 2025;
            
            // Reset year
            document.querySelectorAll('.filter-btn[data-year]').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.year) === defaultYear) {
                    btn.classList.add('active');
                }
            });
            
            // Reset month to All
            document.querySelectorAll('.filter-btn[data-month]').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.month === '0') {
                    btn.classList.add('active');
                }
            });
            
            // Reset status to All
            document.querySelectorAll('.filter-btn[data-status]').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.status === 'all') {
                    btn.classList.add('active');
                }
            });
            
            // Reload data
            showFilterLoading();
            const filters = getFilterValues();
            loadDashboardDataWithFilters(filters).finally(() => {
                hideFilterLoading();
                updateFilterSummary(filters);
            });
        }

        function updateFilterSummary(filters) {
            const summaryText = document.getElementById('filter-summary-text');
            if (!summaryText) return;
            
            let text = '';
            
            if (filters.month > 0) {
                text = `Tháng ${filters.month}/${filters.year}`;
            } else {
                text = `Tất cả dữ liệu năm ${filters.year}`;
            }
            
            if (filters.status && filters.status !== 'all') {
                const statusNames = {
                    pending: 'Chờ xử lý',
                    confirmed: 'Đã xác nhận',
                    delivered: 'Hoàn thành',
                    cancelled: 'Đã hủy'
                };
                text += ` - ${statusNames[filters.status] || filters.status}`;
            }
            
            summaryText.textContent = text;
        }

        async function loadDashboardDataWithFilters(filters) {
            try {
                // Build query params
                const params = new URLSearchParams();
                if (filters.year) params.append('year', filters.year);
                if (filters.month && filters.month > 0) params.append('month', filters.month);
                if (filters.status && filters.status !== 'all') params.append('status', filters.status);
                
                const queryString = params.toString() ? `?${params.toString()}` : '';

                // Load TẤT CẢ dữ liệu với filter
                const [ordersRes, revenueMonthlyRes, customersMonthlyRes, reservationsByTimeRes, newsViewsMonthlyRes, topProductsRes, paymentMethodsRes] = await Promise.all([
                    fetch(`${API_BASE}/orders/stats${queryString}`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/revenue-monthly${queryString}`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/customers-monthly${queryString}`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/reservations-by-time${queryString}`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/news-views-monthly${queryString}`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/top-products${queryString}`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/payment-methods${queryString}`, { credentials: 'include' }).catch(() => null)
                ]);

                // Cập nhật KPI Cards
                if (ordersRes && ordersRes.ok) {
                    const data = await ordersRes.json();
                    if (data.success !== false) {
                        document.getElementById('total-revenue').textContent = formatCurrency(data.totalRevenue || 0) + 'đ';
                        document.getElementById('total-orders').textContent = data.totalOrders || 0;
                        updateGaugeChart(data.totalRevenue || 0, 100000000);
                        updateOrdersChart(data.byStatus || []);
                        
                        // Cập nhật so sánh với tháng trước
                        if (data.comparison) {
                            updateComparisonDisplay('revenue-compare', data.comparison.revenueChange);
                            updateComparisonDisplay('orders-compare', data.comparison.ordersChange);
                        }
                    }
                }

                // Cập nhật biểu đồ doanh thu
                if (revenueMonthlyRes && revenueMonthlyRes.ok) {
                    const data = await revenueMonthlyRes.json();
                    if (data.success && data.data) {
                        updateRevenueChartWithYear(data.data, filters.year);
                    }
                }

                // Cập nhật biểu đồ khách hàng mới
                if (customersMonthlyRes && customersMonthlyRes.ok) {
                    const data = await customersMonthlyRes.json();
                    if (data.success && data.data) {
                        updateCustomerChartWithYear(data.data, filters.year);
                    }
                }

                // Cập nhật biểu đồ đặt bàn theo giờ
                if (reservationsByTimeRes && reservationsByTimeRes.ok) {
                    const data = await reservationsByTimeRes.json();
                    if (data.success && data.data) {
                        updateReservationChart(data.data);
                    }
                }

                // Cập nhật biểu đồ lượt xem tin tức
                if (newsViewsMonthlyRes && newsViewsMonthlyRes.ok) {
                    const data = await newsViewsMonthlyRes.json();
                    if (data.success && data.data) {
                        updateNewsViewsChartWithYear(data.data, filters.year);
                    }
                }

                // Cập nhật top products
                if (topProductsRes && topProductsRes.ok) {
                    const data = await topProductsRes.json();
                    if (data.success && data.data) {
                        renderTopProductsFiltered(data.data);
                    }
                }

                // Cập nhật biểu đồ phương thức thanh toán
                if (paymentMethodsRes && paymentMethodsRes.ok) {
                    const data = await paymentMethodsRes.json();
                    if (data.success && data.data) {
                        updatePaymentMethodsChart(data.data);
                    }
                }

                // Load lại recent orders với filter status
                await renderRecentOrdersWithFilter(filters.status);

            } catch (error) {
                console.error('Error loading filtered data:', error);
            }
        }

        function updateRevenueChartWithYear(data, year) {
            const monthlyData = new Array(12).fill(0);
            const targetYear = year || new Date().getFullYear();
            
            data.forEach(item => {
                if (item.nam === targetYear && item.thang >= 1 && item.thang <= 12) {
                    monthlyData[item.thang - 1] = Math.round((item.doanh_thu || 0) / 1000000);
                }
            });

            revenueChart.data.datasets[0].data = monthlyData;
            revenueChart.update();
        }

        function updateCustomerChartWithYear(data, year) {
            const monthlyData = new Array(12).fill(0);
            const targetYear = year || new Date().getFullYear();
            
            data.forEach(item => {
                if (item.nam === targetYear && item.thang >= 1 && item.thang <= 12) {
                    monthlyData[item.thang - 1] = item.so_luong || 0;
                }
            });

            customerChart.data.datasets[0].data = monthlyData;
            customerChart.update();
        }

        function updateNewsViewsChartWithYear(data, year) {
            const monthlyData = new Array(12).fill(0);
            const targetYear = year || new Date().getFullYear();
            
            data.forEach(item => {
                if (item.nam === targetYear && item.thang >= 1 && item.thang <= 12) {
                    monthlyData[item.thang - 1] = item.tong_luot_xem || 0;
                }
            });

            newsViewsChart.data.datasets[0].data = monthlyData;
            newsViewsChart.update();
        }

        function renderTopProductsFiltered(products) {
            const container = document.getElementById('top-products');
            if (!products || products.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Chưa có dữ liệu</p>';
                return;
            }

            const maxSold = Math.max(...products.map(p => p.da_ban || 0));
            container.innerHTML = products.map((p, i) => `
                <div class="product-row">
                    <span class="w-7 h-7 rounded-full bg-slate-600 text-white text-xs font-bold flex items-center justify-center mr-3">${i + 1}</span>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800 truncate">${p.ten_mon}</p>
                        <div class="w-full bg-slate-100 rounded-full h-2 mt-1">
                            <div class="bg-slate-600 h-2 rounded-full transition-all" style="width: ${maxSold > 0 ? (p.da_ban/maxSold)*100 : 0}%"></div>
                        </div>
                    </div>
                    <span class="text-sm font-semibold text-slate-700 ml-3">${p.da_ban || 0}</span>
                </div>
            `).join('');
        }

        function updatePaymentMethodsChart(data) {
            if (!paymentMethodsChart || !data || data.length === 0) {
                // Nếu không có dữ liệu, hiển thị chart rỗng
                paymentMethodsChart.data.labels = ['Chưa có dữ liệu'];
                paymentMethodsChart.data.datasets[0].data = [1];
                paymentMethodsChart.data.datasets[0].backgroundColor = ['#e2e8f0'];
                paymentMethodsChart.update();
                return;
            }

            // Map tên phương thức thanh toán (theo dữ liệu trong bảng thanh_toan)
            const methodNames = {
                'cod': 'Tiền mặt (COD)',
                'momo': 'MoMo',
                'vnpay': 'VNPay',
                'zalopay': 'ZaloPay',
                'bank_transfer': 'Chuyển khoản',
                'cash': 'Tiền mặt'
            };

            // Map màu cho từng phương thức
            const methodColors = {
                'cod': '#10b981',
                'momo': '#a855f7',
                'vnpay': '#3b82f6',
                'zalopay': '#06b6d4',
                'bank_transfer': '#f59e0b',
                'cash': '#10b981'
            };

            const labels = [];
            const values = [];
            const colors = [];

            data.forEach((item) => {
                const method = item.phuong_thuc_thanh_toan || 'Khác';
                const methodName = methodNames[method] || method;
                labels.push(methodName);
                values.push(item.so_luong || 0);
                colors.push(methodColors[method] || '#9ca3af');
            });

            paymentMethodsChart.data.labels = labels;
            paymentMethodsChart.data.datasets[0].data = values;
            paymentMethodsChart.data.datasets[0].backgroundColor = colors;
            paymentMethodsChart.update();
        }

        async function renderRecentOrdersWithFilter(status) {
            const container = document.getElementById('recent-orders');
            const statusColors = { delivered: 'bg-emerald-100 text-emerald-700', confirmed: 'bg-blue-100 text-blue-700', preparing: 'bg-blue-100 text-blue-700', pending: 'bg-amber-100 text-amber-700', cancelled: 'bg-red-100 text-red-700' };
            const statusText = { delivered: 'Hoàn thành', confirmed: 'Đã xác nhận', preparing: 'Đang chuẩn bị', pending: 'Chờ xác nhận', cancelled: 'Đã hủy' };
            
            try {
                let url = `${API_BASE}/orders/all?limit=5`;
                if (status && status !== 'all') {
                    url += `&status=${status}`;
                }
                
                const response = await fetch(url, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(o => `
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition">
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-800">#DH${String(o.ma_don_hang).padStart(6, '0')} - ${o.ten_khach_hang || o.ten_khach_vang_lai || 'Khách hàng'}</p>
                                    <p class="text-xs text-gray-500 mt-0.5">${formatTimeAgo(o.thoi_gian_tao)}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-bold text-blue-600">${formatCurrency(o.tong_tien || 0)}đ</p>
                                    <span class="text-xs px-2 py-1 rounded-full ${statusColors[o.trang_thai] || 'bg-gray-100 text-gray-700'} font-medium">${statusText[o.trang_thai] || o.trang_thai}</span>
                                </div>
                            </div>
                        `).join('');
                        return;
                    }
                }
            } catch (error) {
                console.error('Error loading recent orders:', error);
            }
            container.innerHTML = '<p class="text-center text-gray-500 py-4">Không có đơn hàng phù hợp</p>';
        }

        // ========== 5 MỤC TIÊU THÁNG ==========
        async function loadGoals() {
            try {
                const response = await fetch(`${API_BASE}/admin-chatbot/goals`, { credentials: 'include' });
                const result = await response.json();
                
                if (result.success) {
                    const { goals, actual, totalProgress = 0, month, year, hasGoals } = result.data;
                    
                    // Cập nhật tiêu đề
                    document.getElementById('goals-month-year').textContent = `(Tháng ${month}/${year})`;
                    document.getElementById('total-progress-badge').textContent = `${totalProgress || 0}%`;
                    
                    // Ẩn/hiện nút tạo mục tiêu và nút reset dựa trên hasGoals
                    const btnGenerate = document.getElementById('btn-generate-goals');
                    const btnReset = document.getElementById('btn-reset-goals');
                    
                    if (hasGoals) {
                        // Đã có mục tiêu -> đổi thành nút "Đề xuất chiến lược"
                        btnGenerate.innerHTML = '<i class="fas fa-lightbulb mr-1"></i>AI Đề xuất';
                        btnGenerate.onclick = () => openAIStrategy();
                        btnGenerate.className = 'px-3 py-1.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg text-xs hover:opacity-90 transition';
                        // Hiện nút reset
                        btnReset.classList.remove('hidden');
                    } else {
                        // Chưa có mục tiêu -> nút tạo mới
                        btnGenerate.innerHTML = '<i class="fas fa-magic mr-1"></i>AI Tạo mục tiêu';
                        btnGenerate.onclick = () => generateGoals();
                        btnGenerate.className = 'px-3 py-1.5 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg text-xs hover:opacity-90 transition';
                        // Ẩn nút reset
                        btnReset.classList.add('hidden');
                    }
                    
                    // Cập nhật gauge chart với tổng tiến độ
                    if (hasGoals) {
                        updateGaugeChart(totalProgress || 0, 100);
                        document.getElementById('gauge-value').textContent = (totalProgress || 0) + '%';
                    }
                    
                    const container = document.getElementById('goals-container');
                    
                    if (!hasGoals || goals.length === 0) {
                        container.innerHTML = `
                            <div class="col-span-5 text-center py-8">
                                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-bullseye text-purple-500 text-2xl"></i>
                                </div>
                                <p class="text-gray-500 mb-3">Chưa có mục tiêu cho tháng này</p>
                                <p class="text-xs text-gray-400 mb-3">Mỗi tháng chỉ được tạo mục tiêu 1 lần</p>
                                <button onclick="generateGoals()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg text-sm hover:opacity-90 transition">
                                    <i class="fas fa-magic mr-2"></i>AI Tạo 5 mục tiêu
                                </button>
                            </div>
                        `;
                        return;
                    }
                    
                    // Render 5 mục tiêu
                    container.innerHTML = goals.map(goal => {
                        const progressColor = goal.tien_do >= 100 ? 'bg-green-500' : goal.tien_do >= 70 ? 'bg-blue-500' : goal.tien_do >= 40 ? 'bg-yellow-500' : 'bg-red-500';
                        const statusIcon = goal.hoan_thanh ? '✅' : goal.tien_do >= 70 ? '🔥' : goal.tien_do >= 40 ? '⚡' : '🎯';
                        
                        return `
                            <div class="bg-gradient-to-br from-slate-50 to-white border border-slate-200 rounded-xl p-4 hover:shadow-md transition">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-2xl">${goal.icon}</span>
                                    <span class="text-xs font-bold ${goal.hoan_thanh ? 'text-green-600' : 'text-gray-500'}">${statusIcon} ${goal.tien_do}%</span>
                                </div>
                                <h4 class="font-semibold text-sm text-gray-800 mb-1">${goal.ten_muc_tieu}</h4>
                                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                    <div class="${progressColor} h-2 rounded-full transition-all duration-500" style="width: ${goal.tien_do}%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>${formatGoalValue(goal.gia_tri_hien_tai, goal.loai_muc_tieu)}</span>
                                    <span>/ ${formatGoalValue(goal.gia_tri_muc_tieu, goal.loai_muc_tieu)}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading goals:', error);
                document.getElementById('goals-container').innerHTML = `
                    <div class="col-span-5 text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p class="text-sm">Lỗi tải mục tiêu</p>
                    </div>
                `;
            }
        }
        
        // Mở AI đề xuất chiến lược
        function openAIStrategy() {
            // Mở chatbot và gửi câu hỏi đề xuất chiến lược
            if (!adminChatOpen) {
                toggleAdminChat();
            }
            setTimeout(() => {
                document.getElementById('admin-chat-input').value = 'Đề xuất chiến lược cải thiện để đạt mục tiêu tháng này';
                sendAdminChat();
            }, 300);
        }
        
        function formatGoalValue(value, type) {
            // Làm tròn số, bỏ phần thập phân
            const roundedValue = Math.round(parseFloat(value) || 0);
            
            if (type === 'doanh_thu') {
                if (roundedValue >= 1000000000) {
                    return (roundedValue / 1000000000).toFixed(1) + ' tỷ';
                }
                if (roundedValue >= 1000000) {
                    return (roundedValue / 1000000).toFixed(1).replace('.0', '') + ' triệu';
                }
                if (roundedValue >= 1000) {
                    return new Intl.NumberFormat('vi-VN').format(roundedValue) + 'đ';
                }
                return roundedValue + 'đ';
            }
            // Các loại khác: số nguyên
            return roundedValue.toLocaleString('vi-VN');
        }
        
        async function generateGoals() {
            const btn = document.getElementById('btn-generate-goals');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Đang tạo...';
            
            try {
                const response = await fetch(`${API_BASE}/admin-chatbot/goals/generate`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    // Reload goals
                    await loadGoals();
                    // Thông báo thành công
                    showToast('✅ Đã tạo 5 mục tiêu mới cho tháng này!', 'success');
                } else {
                    // Nếu mục tiêu đã tồn tại
                    if (result.alreadyExists) {
                        showToast('⚠️ ' + result.message, 'warning');
                    } else {
                        showToast('❌ ' + result.message, 'error');
                    }
                }
            } catch (error) {
                console.error('Error generating goals:', error);
                showToast('❌ Không thể tạo mục tiêu', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-1"></i>AI Tạo mục tiêu';
            }
        }
        
        // Hàm hiển thị toast notification
        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-pulse`;
            toast.innerHTML = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }
        
        function refreshGoals() {
            loadGoals();
        }
        
        // Xóa mục tiêu để tạo lại
        async function resetGoals() {
            if (!confirm('Bạn có chắc muốn xóa tất cả mục tiêu tháng này?\nSau khi xóa, bạn có thể tạo lại mục tiêu mới.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin-chatbot/goals`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast('✅ Đã xóa mục tiêu. Bạn có thể tạo lại!', 'success');
                    await loadGoals();
                } else {
                    showToast('❌ ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error resetting goals:', error);
                showToast('❌ Không thể xóa mục tiêu', 'error');
            }
        }
        
        // Load goals khi trang load
        setTimeout(loadGoals, 500);

        // ========== ADMIN AI CHATBOT ==========
        let adminChatOpen = false;
        
        function toggleAdminChat() {
            const chatWindow = document.getElementById('admin-chat-window');
            adminChatOpen = !adminChatOpen;
            
            if (adminChatOpen) {
                chatWindow.classList.remove('hidden', 'scale-95', 'opacity-0');
                chatWindow.classList.add('scale-100', 'opacity-100');
                // Load mục tiêu khi mở chat
                loadTargetForGauge();
            } else {
                chatWindow.classList.add('scale-95', 'opacity-0');
                setTimeout(() => chatWindow.classList.add('hidden'), 200);
            }
        }
        
        async function sendAdminChat() {
            const input = document.getElementById('admin-chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            // Hiển thị tin nhắn người dùng
            appendAdminMessage(message, 'user');
            input.value = '';
            
            // Hiển thị loading với ID cố định
            const loadingId = 'chat-loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex justify-start mb-3';
            loadingDiv.innerHTML = `
                <div class="flex items-start space-x-2 max-w-[90%]">
                    <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div class="bg-gray-100 px-4 py-2 rounded-2xl rounded-tl-sm text-sm text-gray-800">
                        <i class="fas fa-spinner fa-spin mr-1"></i> Đang phân tích...
                    </div>
                </div>`;
            const chatContainer = document.getElementById('admin-chat-messages');
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                const response = await fetch(`${API_BASE}/admin-chatbot/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ message })
                });
                
                const result = await response.json();
                
                // Xóa loading - đảm bảo xóa được
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                if (result.success) {
                    appendAdminMessage(result.data.message, 'bot');
                    
                    // Hiển thị suggestions
                    if (result.data.suggestions) {
                        appendSuggestions(result.data.suggestions);
                    }
                    
                    // Nếu có đề xuất mục tiêu, hiển thị nút đặt mục tiêu
                    if (result.data.suggestedTarget) {
                        appendTargetButtons(result.data.suggestedTarget);
                    }
                    
                    // Nếu cần hiển thị nút tạo mục tiêu
                    if (result.data.showGenerateButton || result.data.action === 'generate_goals') {
                        appendGenerateGoalsButton();
                    }
                } else {
                    appendAdminMessage('❌ ' + (result.message || 'Có lỗi xảy ra'), 'bot');
                }
            } catch (error) {
                // Xóa loading khi lỗi
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                appendAdminMessage('❌ Không thể kết nối server', 'bot');
            }
        }
        
        function appendAdminMessage(content, type, isLoading = false) {
            const container = document.getElementById('admin-chat-messages');
            const id = 'msg-' + Date.now();
            
            const msgDiv = document.createElement('div');
            msgDiv.id = id;
            msgDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'} mb-3`;
            
            const bubble = type === 'user' 
                ? `<div class="bg-blue-600 text-white px-4 py-2 rounded-2xl rounded-br-sm max-w-[85%] text-sm">${content}</div>`
                : `<div class="flex items-start space-x-2 max-w-[90%]">
                    <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div class="bg-gray-100 px-4 py-2 rounded-2xl rounded-tl-sm text-sm text-gray-800 whitespace-pre-line">${content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>
                </div>`;
            
            msgDiv.innerHTML = bubble;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            
            return id;
        }
        
        function appendSuggestions(suggestions) {
            const container = document.getElementById('admin-chat-messages');
            const div = document.createElement('div');
            div.className = 'flex flex-wrap gap-2 mb-3 ml-10';
            div.innerHTML = suggestions.map(s => 
                `<button onclick="quickAdminChat('${s}')" class="bg-white border border-blue-200 text-blue-600 px-3 py-1 rounded-full text-xs hover:bg-blue-50 transition">${s}</button>`
            ).join('');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        function appendTargetButtons(target) {
            const container = document.getElementById('admin-chat-messages');
            const div = document.createElement('div');
            div.className = 'flex gap-2 mb-3 ml-10';
            div.innerHTML = `
                <button onclick="setMonthlyTarget(${target.revenue}, ${target.orders})" class="bg-green-500 text-white px-4 py-2 rounded-lg text-xs hover:bg-green-600 transition">
                    <i class="fas fa-check mr-1"></i> Đặt mục tiêu này
                </button>
                <button onclick="quickAdminChat('Điều chỉnh mục tiêu cao hơn')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-xs hover:bg-gray-300 transition">
                    Điều chỉnh
                </button>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        function quickAdminChat(message) {
            document.getElementById('admin-chat-input').value = message;
            sendAdminChat();
        }
        
        function appendGenerateGoalsButton() {
            const container = document.getElementById('admin-chat-messages');
            const div = document.createElement('div');
            div.className = 'flex gap-2 mb-3 ml-10';
            div.innerHTML = `
                <button onclick="generateGoalsFromChat()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg text-xs hover:opacity-90 transition">
                    <i class="fas fa-magic mr-1"></i> Tạo 5 mục tiêu ngay
                </button>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        async function generateGoalsFromChat() {
            appendAdminMessage('Đang tạo 5 mục tiêu...', 'user');
            
            try {
                const response = await fetch(`${API_BASE}/admin-chatbot/goals/generate`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    appendAdminMessage('✅ Đã tạo 5 mục tiêu mới!\n\n' + result.data.map(g => `${g.icon} ${g.ten_muc_tieu}: ${g.loai_muc_tieu === 'doanh_thu' ? new Intl.NumberFormat('vi-VN').format(g.gia_tri_muc_tieu) + 'đ' : g.gia_tri_muc_tieu + ' ' + g.don_vi}`).join('\n'), 'bot');
                    appendSuggestions(['Xem tiến độ mục tiêu', 'Báo cáo tháng này']);
                    // Reload goals trên dashboard
                    loadGoals();
                } else {
                    appendAdminMessage('❌ Lỗi: ' + result.message, 'bot');
                }
            } catch (error) {
                appendAdminMessage('❌ Không thể tạo mục tiêu', 'bot');
            }
        }
        
        async function setMonthlyTarget(revenue, orders) {
            try {
                const response = await fetch(`${API_BASE}/admin-chatbot/target`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        muc_tieu_doanh_thu: revenue, 
                        muc_tieu_don_hang: orders,
                        ghi_chu: 'Đặt bởi AI Assistant'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    appendAdminMessage('✅ Đã đặt mục tiêu thành công! Biểu đồ tỷ lệ hoàn thành đã được cập nhật.', 'bot');
                    // Cập nhật biểu đồ gauge
                    loadTargetForGauge();
                } else {
                    appendAdminMessage('❌ Không thể đặt mục tiêu: ' + result.message, 'bot');
                }
            } catch (error) {
                appendAdminMessage('❌ Lỗi kết nối server', 'bot');
            }
        }
        
        async function loadTargetForGauge() {
            try {
                // Lấy dữ liệu từ goals API để cập nhật gauge
                const response = await fetch(`${API_BASE}/admin-chatbot/goals`, { credentials: 'include' });
                const result = await response.json();
                
                if (result.success && result.data && result.data.hasGoals) {
                    const totalProgress = result.data.totalProgress || 0;
                    updateGaugeChart(totalProgress, 100);
                    document.getElementById('gauge-value').textContent = totalProgress + '%';
                } else {
                    // Fallback to old gauge-data API
                    const gaugeResponse = await fetch(`${API_BASE}/admin-chatbot/gauge-data`, { credentials: 'include' });
                    const gaugeResult = await gaugeResponse.json();
                    
                    if (gaugeResult.success && gaugeResult.data) {
                        updateGaugeChart(gaugeResult.data.current, gaugeResult.data.target);
                    }
                }
            } catch (error) {
                console.error('Error loading gauge data:', error);
            }
        }
        
        // Load gauge data khi trang load (sau khi load goals)
        setTimeout(loadTargetForGauge, 1500);
    </script>
    
    <!-- Admin AI Chatbot Button -->
    <button onclick="toggleAdminChat()" class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-br from-purple-600 to-pink-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all z-50 flex items-center justify-center group">
        <i class="fas fa-robot text-xl group-hover:scale-110 transition-transform"></i>
        <span class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></span>
    </button>
    
    <!-- Admin AI Chat Window -->
    <div id="admin-chat-window" class="fixed bottom-24 right-6 w-96 bg-white rounded-2xl shadow-2xl z-50 hidden scale-95 opacity-0 transition-all duration-200 overflow-hidden" style="max-height: 600px;">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-4 text-white">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-bold">Phương Nam</h3>
                        <p class="text-xs text-purple-200">Trợ lý AI của chị Linh 💜</p>
                    </div>
                </div>
                <button onclick="toggleAdminChat()" class="text-white/80 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Messages -->
        <div id="admin-chat-messages" class="p-4 overflow-y-auto" style="height: 350px;">
            <!-- Welcome message -->
            <div class="flex justify-start mb-3">
                <div class="flex items-start space-x-2 max-w-[90%]">
                    <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div class="bg-gray-100 px-4 py-2 rounded-2xl rounded-tl-sm text-sm text-gray-800">
                        👋 <strong>Chào chị Linh!</strong><br><br>
                        Em là <strong>Phương Nam</strong> - trợ lý AI của chị.<br><br>
                        Em có thể giúp chị:<br>
                        📊 Xem báo cáo kinh doanh<br>
                        🎯 Đặt và theo dõi mục tiêu<br>
                        📈 Đề xuất chiến lược tăng doanh thu<br><br>
                        <em>Chị cần em hỗ trợ gì ạ?</em> 😊
                    </div>
                </div>
            </div>
            <!-- Quick suggestions -->
            <div class="flex flex-wrap gap-2 mb-3 ml-10">
                <button onclick="quickAdminChat('Báo cáo tháng này')" class="bg-white border border-blue-200 text-blue-600 px-3 py-1 rounded-full text-xs hover:bg-blue-50 transition">📊 Báo cáo</button>
                <button onclick="quickAdminChat('Tiến độ mục tiêu')" class="bg-white border border-blue-200 text-blue-600 px-3 py-1 rounded-full text-xs hover:bg-blue-50 transition">🎯 Tiến độ</button>
                <button onclick="quickAdminChat('Đề xuất chiến lược')" class="bg-white border border-blue-200 text-blue-600 px-3 py-1 rounded-full text-xs hover:bg-blue-50 transition">📈 Chiến lược</button>
            </div>
        </div>
        
        <!-- Input -->
        <div class="p-4 border-t bg-gray-50">
            <div class="flex space-x-2">
                <input type="text" id="admin-chat-input" placeholder="Hỏi về doanh thu, chiến lược..." 
                       class="flex-1 px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 text-sm"
                       onkeypress="if(event.key==='Enter') sendAdminChat()">
                <button onclick="sendAdminChat()" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-xl hover:opacity-90 transition">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</body>
</html>
