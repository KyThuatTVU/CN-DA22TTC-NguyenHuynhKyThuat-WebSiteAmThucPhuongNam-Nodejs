<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin Phương Nam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="admin-styles.css">
    <link rel="stylesheet" href="admin-responsive.css">
    <style>
        body { background: #f0f4f8; }
        .sidebar { background: linear-gradient(180deg, #1e3a5f 0%, #0f2744 100%); }
        .sidebar-item { color: #94a3b8; transition: all 0.2s; }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .sidebar-item.active { background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%); color: #fff; }
        .kpi-card { background: #fff; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(30,58,95,0.08); }
        .kpi-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; }
        .kpi-value { font-size: 2rem; font-weight: 700; color: #1e3a5f; }
        .kpi-label { font-size: 0.875rem; color: #64748b; margin-bottom: 4px; }
        .kpi-compare { font-size: 0.75rem; color: #64748b; }
        .kpi-compare .up { color: #10b981; }
        .kpi-compare .down { color: #ef4444; }
        .chart-card { background: #fff; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(30,58,95,0.08); }
        .chart-title { font-size: 1rem; font-weight: 600; color: #1e3a5f; margin-bottom: 20px; }
        .filter-section { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(30,58,95,0.08); }
        .filter-group { margin-bottom: 20px; }
        .filter-label { font-size: 0.75rem; font-weight: 600; color: #1e3a5f; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-btn { padding: 8px 14px; border-radius: 8px; font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: all 0.2s; border: 1px solid #e2e8f0; }
        .filter-btn.active { background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%); color: #fff; border-color: transparent; }
        .filter-btn:not(.active) { background: #f8fafc; color: #475569; }
        .filter-btn:hover:not(.active) { background: #e2e8f0; }
        .header-bar { background: linear-gradient(90deg, #1e3a5f 0%, #2d4a6f 100%); color: #fff; padding: 16px 28px; }
        .product-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
        .product-row:last-child { border-bottom: none; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #64748b; }
        .legend-dot { width: 12px; height: 12px; border-radius: 4px; }
        .admin-card { background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%); border-radius: 12px; padding: 16px; }
    </style>
</head>
<body>
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 flex-shrink-0 transition-all duration-300">
            <div class="h-full flex flex-col">
                <!-- Logo -->
                <div class="p-5 border-b border-white/10">
                    <div class="flex items-center space-x-3">
                        <img src="../images/Green Simple Clean Vegan Food Logo.png" alt="Logo" class="w-11 h-11 rounded-xl object-contain bg-white p-1">
                        <div>
                            <h1 class="font-bold text-white text-lg">Phương Nam</h1>
                            <p class="text-xs text-blue-300">Hệ thống quản trị</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 overflow-y-auto p-4">
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Menu chính</p>
                    <div class="space-y-1">
                        <a href="dashboard.html" class="sidebar-item active flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-chart-pie w-5"></i><span class="text-sm font-medium">Tổng quan</span>
                        </a>
                        <a href="products.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-utensils w-5"></i><span class="text-sm">Món ăn</span>
                        </a>
                        <a href="orders.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-shopping-cart w-5"></i><span class="text-sm">Đơn hàng</span>
                        </a>
                        <a href="reservations.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-calendar-check w-5"></i><span class="text-sm">Đặt bàn</span>
                        </a>
                        <a href="customers.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-users w-5"></i><span class="text-sm">Khách hàng</span>
                        </a>
                        <a href="contacts.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-envelope w-5"></i><span class="text-sm">Liên hệ</span>
                        </a>
                        <a href="reviews.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-star w-5"></i><span class="text-sm">Đánh giá</span>
                        </a>
                    </div>
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-3">Nội dung</p>
                    <div class="space-y-1">
                        <a href="news.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-newspaper w-5"></i><span class="text-sm">Tin tức</span>
                        </a>
                        <a href="quan-ly-binh-luan.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-comments w-5"></i><span class="text-sm">Bình luận tin tức</span>
                        </a>
                        <a href="quan-ly-danh-gia-tin-tuc.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-thumbs-up w-5"></i><span class="text-sm">Reactions tin tức</span>
                        </a>
                        <a href="albums.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-images w-5"></i><span class="text-sm">Album ảnh</span>
                        </a>
                    </div>
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-3">Hệ thống</p>
                    <div class="space-y-1">
                        <a href="settings.html" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl">
                            <i class="fas fa-cog w-5"></i><span class="text-sm">Cài đặt</span>
                        </a>
                    </div>
                </nav>

                <!-- Admin Profile Card -->
                <div class="p-4 border-t border-white/10">
                    <div class="admin-card">
                        <div class="flex items-center space-x-3">
                            <img id="admin-avatar" referrerpolicy="no-referrer" src="https://ui-avatars.com/api/?name=Admin&background=3b82f6&color=fff" alt="Admin" class="w-12 h-12 rounded-full border-2 border-blue-400">
                            <div class="flex-1 min-w-0">
                                <p id="admin-name" class="font-semibold text-sm text-white truncate">Đang tải...</p>
                                <p id="admin-email" class="text-xs text-blue-300 truncate">admin@example.com</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-3 pt-3 border-t border-white/20">
                            <span class="text-xs text-blue-300"><i class="fab fa-google mr-1"></i>Google Account</span>
                            <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300 transition flex items-center">
                                <i class="fas fa-sign-out-alt mr-1"></i>Đăng xuất
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Sidebar Overlay -->
            <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
            
            <!-- Header Bar -->
            <header class="header-bar flex items-center justify-between">
                <div class="flex items-center space-x-3 sm:space-x-4">
                    <button onclick="toggleSidebar()" class="mobile-menu-btn lg:hidden text-white"><i class="fas fa-bars text-xl"></i></button>
                    <div>
                        <h2 class="text-base sm:text-xl font-bold">Dashboard</h2>
                        <p class="text-xs sm:text-sm text-blue-200 hidden sm:block">Báo cáo tổng quan nhà hàng</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="relative text-white hover:text-blue-200 transition">
                        <i class="fas fa-bell text-lg"></i>
                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">3</span>
                    </button>
                    <a href="../index.html" target="_blank" class="text-white hover:text-blue-200 transition" title="Xem website">
                        <i class="fas fa-external-link-alt text-lg"></i>
                    </a>
                    <div class="hidden md:flex items-center space-x-3 pl-4 border-l border-white/20">
                        <img id="admin-avatar-header" referrerpolicy="no-referrer" src="https://ui-avatars.com/api/?name=Admin&background=3b82f6&color=fff" alt="Admin" class="w-10 h-10 rounded-full border-2 border-blue-400">
                        <div>
                            <p id="admin-name-header" class="font-semibold text-sm text-white">Admin</p>
                            <p class="text-xs text-blue-200">Quản trị viên</p>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="flex gap-6">
                    <!-- Main Content Area -->
                    <div class="flex-1">
                        <!-- KPI Cards -->
                        <div class="grid grid-cols-4 gap-5 mb-6">
                            <div class="kpi-card">
                                <div class="flex items-center gap-4">
                                    <div class="kpi-icon bg-gradient-to-br from-blue-500 to-blue-600">
                                        <i class="fas fa-dollar-sign text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="kpi-label">Tổng doanh thu</p>
                                        <p class="kpi-value" id="total-revenue">0đ</p>
                                        <p class="kpi-compare">So với tháng trước: <span class="up"><i class="fas fa-arrow-up"></i> 12.5%</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card">
                                <div class="flex items-center gap-4">
                                    <div class="kpi-icon bg-gradient-to-br from-emerald-500 to-emerald-600">
                                        <i class="fas fa-shopping-cart text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="kpi-label">Số đơn hàng</p>
                                        <p class="kpi-value" id="total-orders">0</p>
                                        <p class="kpi-compare">So với tháng trước: <span class="up"><i class="fas fa-arrow-up"></i> 8.2%</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card">
                                <div class="flex items-center gap-4">
                                    <div class="kpi-icon bg-gradient-to-br from-amber-500 to-amber-600">
                                        <i class="fas fa-users text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="kpi-label">Khách hàng</p>
                                        <p class="kpi-value" id="total-customers">0</p>
                                        <p class="kpi-compare">So với tháng trước: <span class="up"><i class="fas fa-arrow-up"></i> 5.3%</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card">
                                <div class="flex items-center gap-4">
                                    <div class="kpi-icon bg-gradient-to-br from-purple-500 to-purple-600">
                                        <i class="fas fa-calendar-check text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="kpi-label">Đặt bàn</p>
                                        <p class="kpi-value" id="total-reservations">0</p>
                                        <p class="kpi-compare">So với tháng trước: <span class="up"><i class="fas fa-arrow-up"></i> 15.1%</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Gauge + Revenue Chart -->
                        <div class="grid grid-cols-3 gap-5 mb-6">
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-bullseye text-blue-500 mr-2"></i>Tỷ lệ hoàn thành mục tiêu</p>
                                <div style="height: 160px; position: relative;">
                                    <canvas id="gaugeChart"></canvas>
                                    <div style="position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); text-align: center;">
                                        <p class="text-3xl font-bold text-blue-600" id="gauge-value">0%</p>
                                        <p class="text-xs text-gray-500">Doanh thu tháng</p>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-card col-span-2">
                                <p class="chart-title"><i class="fas fa-chart-bar text-emerald-500 mr-2"></i>Doanh thu 12 tháng gần nhất</p>
                                <div style="height: 200px;"><canvas id="revenueChart"></canvas></div>
                                <div class="flex justify-center gap-8 mt-3">
                                    <div class="legend-item"><div class="legend-dot" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8)"></div> Doanh thu</div>
                                    <div class="legend-item"><div class="legend-dot" style="background:#e2e8f0"></div> Mục tiêu</div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: Orders + Top Products + Customers -->
                        <div class="grid grid-cols-3 gap-5 mb-6">
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-pie-chart text-purple-500 mr-2"></i>Đơn hàng theo trạng thái</p>
                                <div style="height: 200px;"><canvas id="ordersChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-fire text-orange-500 mr-2"></i>Top 10 món ăn bán chạy</p>
                                <div id="top-products" class="space-y-2" style="max-height: 220px; overflow-y: auto;"></div>
                            </div>
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-user-plus text-cyan-500 mr-2"></i>Khách hàng mới theo tháng</p>
                                <div style="height: 200px;"><canvas id="customerChart"></canvas></div>
                            </div>
                        </div>

                        <!-- Row 4: Reservations + Recent Orders -->
                        <div class="grid grid-cols-2 gap-5 mb-6">
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-clock text-amber-500 mr-2"></i>Đặt bàn theo khung giờ</p>
                                <div style="height: 200px;"><canvas id="reservationChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-list-alt text-indigo-500 mr-2"></i>Đơn hàng gần đây</p>
                                <div id="recent-orders" class="space-y-2" style="max-height: 220px; overflow-y: auto;"></div>
                            </div>
                        </div>

                        <!-- Row 5: Reviews Stats -->
                        <div class="grid grid-cols-3 gap-5 mb-6">
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-star text-yellow-500 mr-2"></i>Phân bố đánh giá sao</p>
                                <div style="height: 180px;"><canvas id="reviewStarChart"></canvas></div>
                                <div class="text-center mt-2">
                                    <p class="text-sm text-slate-500">Điểm trung bình</p>
                                    <p class="text-2xl font-bold text-yellow-500" id="avg-rating">0.0 <i class="fas fa-star text-lg"></i></p>
                                </div>
                            </div>
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-chart-pie text-emerald-500 mr-2"></i>Trạng thái đánh giá</p>
                                <div style="height: 200px;"><canvas id="reviewStatusChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <div class="flex items-center justify-between mb-4">
                                    <p class="chart-title mb-0"><i class="fas fa-trophy text-orange-500 mr-2"></i>Top món được đánh giá</p>
                                    <a href="reviews.html" class="text-xs text-blue-500 hover:text-blue-700">Xem tất cả <i class="fas fa-arrow-right"></i></a>
                                </div>
                                <div id="top-reviewed-products" class="space-y-2" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>

                        <!-- Row 6: News Stats -->
                        <div class="grid grid-cols-3 gap-5">
                            <div class="chart-card">
                                <p class="chart-title"><i class="fas fa-newspaper text-pink-500 mr-2"></i>Lượt xem bài viết theo tháng</p>
                                <div style="height: 200px;"><canvas id="newsViewsChart"></canvas></div>
                            </div>
                            <div class="chart-card col-span-2">
                                <div class="flex items-center justify-between mb-4">
                                    <p class="chart-title mb-0"><i class="fas fa-eye text-rose-500 mr-2"></i>Top bài viết được xem nhiều nhất</p>
                                    <div class="flex items-center space-x-4 text-sm">
                                        <span class="text-slate-500">Tổng: <span id="total-news" class="font-bold text-slate-700">0</span> bài</span>
                                        <span class="text-slate-500">Lượt xem: <span id="total-views" class="font-bold text-pink-600">0</span></span>
                                    </div>
                                </div>
                                <div id="top-news" class="space-y-2" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Sidebar -->
                    <div class="w-52 flex-shrink-0">
                        <div class="filter-section sticky top-0">
                            <div class="filter-group">
                                <p class="filter-label">Năm</p>
                                <div class="flex flex-wrap gap-2">
                                    <button class="filter-btn" data-year="2023">2023</button>
                                    <button class="filter-btn active" data-year="2024">2024</button>
                                    <button class="filter-btn" data-year="2025">2025</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <p class="filter-label">Tháng</p>
                                <div class="grid grid-cols-4 gap-2">
                                    <button class="filter-btn" data-month="0">All</button>
                                    <button class="filter-btn" data-month="1">1</button>
                                    <button class="filter-btn" data-month="2">2</button>
                                    <button class="filter-btn" data-month="3">3</button>
                                    <button class="filter-btn" data-month="4">4</button>
                                    <button class="filter-btn" data-month="5">5</button>
                                    <button class="filter-btn" data-month="6">6</button>
                                    <button class="filter-btn" data-month="7">7</button>
                                    <button class="filter-btn" data-month="8">8</button>
                                    <button class="filter-btn" data-month="9">9</button>
                                    <button class="filter-btn" data-month="10">10</button>
                                    <button class="filter-btn active" data-month="11">11</button>
                                    <button class="filter-btn" data-month="12">12</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <p class="filter-label">Trạng thái đơn</p>
                                <div class="flex flex-col gap-2">
                                    <button class="filter-btn active" data-status="all">Tất cả</button>
                                    <button class="filter-btn" data-status="pending">Chờ xử lý</button>
                                    <button class="filter-btn" data-status="confirmed">Đã xác nhận</button>
                                    <button class="filter-btn" data-status="completed">Hoàn thành</button>
                                    <button class="filter-btn" data-status="cancelled">Đã hủy</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="check-auth.js"></script>
    <script src="admin-layout.js"></script>
    <script src="admin-mobile.js"></script>

    <script>
        // API_URL đã được khai báo trong admin-layout.js
        const API_BASE = API_URL; // Alias để tương thích
        let gaugeChart, revenueChart, ordersChart, customerChart, reservationChart, newsViewsChart, reviewStarChart, reviewStatusChart;
        
        document.addEventListener('DOMContentLoaded', function() {
            initAllCharts();
            loadDashboardData();
            initFilters();
        });

        function initAllCharts() {
            // Gauge Chart
            gaugeChart = new Chart(document.getElementById('gaugeChart').getContext('2d'), {
                type: 'doughnut',
                data: { datasets: [{ data: [0, 100], backgroundColor: ['#3b82f6', '#e2e8f0'], borderWidth: 0, circumference: 180, rotation: 270 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });

            // Revenue Chart
            revenueChart = new Chart(document.getElementById('revenueChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
                    datasets: [
                        { label: 'Doanh thu', data: [45, 52, 48, 61, 55, 67, 72, 68, 75, 82, 78, 85], backgroundColor: '#3b82f6', borderRadius: 6, barPercentage: 0.6 },
                        { label: 'Mục tiêu', data: [50, 55, 55, 60, 60, 70, 75, 75, 80, 85, 85, 90], backgroundColor: '#e2e8f0', borderRadius: 6, barPercentage: 0.6 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => v + 'tr' } } } }
            });

            // Orders Chart
            ordersChart = new Chart(document.getElementById('ordersChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Hoàn thành', 'Đang xử lý', 'Chờ xác nhận', 'Đã hủy'], datasets: [{ data: [65, 20, 10, 5], backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'], borderWidth: 3, borderColor: '#fff' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } } } }
            });

            // Customer Chart
            customerChart = new Chart(document.getElementById('customerChart').getContext('2d'), {
                type: 'line',
                data: { labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'], datasets: [{ label: 'Khách mới', data: [12, 19, 15, 25, 22, 30, 28, 35, 32, 40, 38, 45], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 5, pointBackgroundColor: '#3b82f6', pointBorderColor: '#fff', pointBorderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#f1f5f9' } } } }
            });

            // Reservation Chart
            reservationChart = new Chart(document.getElementById('reservationChart').getContext('2d'), {
                type: 'bar',
                data: { labels: ['10-12h', '12-14h', '14-16h', '16-18h', '18-20h', '20-22h'], datasets: [{ label: 'Số lượt đặt', data: [15, 45, 20, 25, 60, 35], backgroundColor: ['#60a5fa', '#3b82f6', '#2563eb', '#1d4ed8', '#1e40af', '#1e3a8a'], borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#f1f5f9' } } } }
            });

            // News Views Chart
            newsViewsChart = new Chart(document.getElementById('newsViewsChart').getContext('2d'), {
                type: 'line',
                data: { 
                    labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'], 
                    datasets: [{ 
                        label: 'Lượt xem', 
                        data: new Array(12).fill(0), 
                        borderColor: '#ec4899', 
                        backgroundColor: 'rgba(236, 72, 153, 0.1)', 
                        borderWidth: 3, 
                        fill: true, 
                        tension: 0.4, 
                        pointRadius: 5, 
                        pointBackgroundColor: '#ec4899', 
                        pointBorderColor: '#fff', 
                        pointBorderWidth: 2 
                    }] 
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#f1f5f9' } } } }
            });

            // Review Star Distribution Chart
            reviewStarChart = new Chart(document.getElementById('reviewStarChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['5 sao', '4 sao', '3 sao', '2 sao', '1 sao'],
                    datasets: [{
                        label: 'Số lượng',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#22c55e', '#84cc16', '#eab308', '#f97316', '#ef4444'],
                        borderRadius: 6,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, grid: { display: false } },
                        y: { grid: { display: false } }
                    }
                }
            });

            // Review Status Chart
            reviewStatusChart = new Chart(document.getElementById('reviewStatusChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Đã duyệt', 'Chờ duyệt', 'Đã khóa'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } }
                    }
                }
            });
        }

        async function loadDashboardData() {
            try {
                // Load tất cả dữ liệu song song
                const [ordersRes, customersRes, reservationsRes, revenueMonthlyRes, customersMonthlyRes, reservationsByTimeRes, newsViewsRes, newsViewsMonthlyRes, reviewsRes] = await Promise.all([
                    fetch(`${API_BASE}/orders/stats`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/customers/stats`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/reservations/stats`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/revenue-monthly`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/customers-monthly`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/reservations-by-time`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/news-views`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/news-views-monthly`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/reviews/admin/all`, { credentials: 'include' }).catch(() => null)
                ]);

                // KPI Cards
                if (ordersRes && ordersRes.ok) {
                    const data = await ordersRes.json();
                    if (data.success !== false) {
                        document.getElementById('total-revenue').textContent = formatCurrency(data.totalRevenue || 0) + 'đ';
                        document.getElementById('total-orders').textContent = data.totalOrders || 0;
                        updateGaugeChart(data.totalRevenue || 0, 100000000);
                        updateOrdersChart(data.byStatus || []);
                    }
                }

                if (customersRes && customersRes.ok) {
                    const data = await customersRes.json();
                    if (data.success !== false) document.getElementById('total-customers').textContent = data.totalCustomers || 0;
                }

                if (reservationsRes && reservationsRes.ok) {
                    const data = await reservationsRes.json();
                    if (data.success !== false) document.getElementById('total-reservations').textContent = data.totalReservations || 0;
                }

                // Biểu đồ doanh thu theo tháng
                if (revenueMonthlyRes && revenueMonthlyRes.ok) {
                    const data = await revenueMonthlyRes.json();
                    if (data.success && data.data) {
                        updateRevenueChart(data.data);
                    }
                }

                // Biểu đồ khách hàng mới theo tháng
                if (customersMonthlyRes && customersMonthlyRes.ok) {
                    const data = await customersMonthlyRes.json();
                    if (data.success && data.data) {
                        updateCustomerChart(data.data);
                    }
                }

                // Biểu đồ đặt bàn theo khung giờ
                if (reservationsByTimeRes && reservationsByTimeRes.ok) {
                    const data = await reservationsByTimeRes.json();
                    if (data.success && data.data) {
                        updateReservationChart(data.data);
                    }
                }

                // Top bài viết và tổng lượt xem
                if (newsViewsRes && newsViewsRes.ok) {
                    const data = await newsViewsRes.json();
                    if (data.success) {
                        document.getElementById('total-news').textContent = data.totalNews || 0;
                        document.getElementById('total-views').textContent = formatNumber(data.totalViews || 0);
                        renderTopNews(data.data || []);
                    }
                }

                // Biểu đồ lượt xem tin tức theo tháng
                if (newsViewsMonthlyRes && newsViewsMonthlyRes.ok) {
                    const data = await newsViewsMonthlyRes.json();
                    if (data.success && data.data) {
                        updateNewsViewsChart(data.data);
                    }
                }

                // Thống kê đánh giá
                if (reviewsRes && reviewsRes.ok) {
                    const data = await reviewsRes.json();
                    if (data.success) {
                        updateReviewCharts(data.stats, data.topProducts);
                    }
                }

                // Load top products và recent orders
                await renderTopProducts();
                await renderRecentOrders();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                await renderTopProducts();
                await renderRecentOrders();
            }
        }

        function updateRevenueChart(data) {
            // Tạo mảng 12 tháng với giá trị 0
            const monthlyData = new Array(12).fill(0);
            const currentYear = new Date().getFullYear();
            
            data.forEach(item => {
                if (item.nam === currentYear && item.thang >= 1 && item.thang <= 12) {
                    monthlyData[item.thang - 1] = Math.round((item.doanh_thu || 0) / 1000000); // Chuyển sang triệu
                }
            });

            revenueChart.data.datasets[0].data = monthlyData;
            revenueChart.update();
        }

        function updateCustomerChart(data) {
            const monthlyData = new Array(12).fill(0);
            const currentYear = new Date().getFullYear();
            
            data.forEach(item => {
                if (item.nam === currentYear && item.thang >= 1 && item.thang <= 12) {
                    monthlyData[item.thang - 1] = item.so_luong || 0;
                }
            });

            customerChart.data.datasets[0].data = monthlyData;
            customerChart.update();
        }

        function updateReservationChart(data) {
            const timeSlots = ['10-12h', '12-14h', '14-16h', '16-18h', '18-20h', '20-22h'];
            const slotData = timeSlots.map(slot => {
                const found = data.find(d => d.khung_gio === slot);
                return found ? found.so_luong : 0;
            });

            reservationChart.data.datasets[0].data = slotData;
            reservationChart.update();
        }

        function updateNewsViewsChart(data) {
            const monthlyData = new Array(12).fill(0);
            const currentYear = new Date().getFullYear();
            
            data.forEach(item => {
                if (item.nam === currentYear && item.thang >= 1 && item.thang <= 12) {
                    monthlyData[item.thang - 1] = item.tong_luot_xem || 0;
                }
            });

            newsViewsChart.data.datasets[0].data = monthlyData;
            newsViewsChart.update();
        }

        function updateReviewCharts(stats, topProducts) {
            // Update star distribution chart
            if (stats && stats.starDistribution && reviewStarChart) {
                const dist = stats.starDistribution;
                reviewStarChart.data.datasets[0].data = [dist[5] || 0, dist[4] || 0, dist[3] || 0, dist[2] || 0, dist[1] || 0];
                reviewStarChart.update();
            }

            // Update average rating
            const avgRating = parseFloat(stats?.average_rating || 0).toFixed(1);
            document.getElementById('avg-rating').innerHTML = `${avgRating} <i class="fas fa-star text-lg"></i>`;

            // Update status chart
            if (stats && reviewStatusChart) {
                reviewStatusChart.data.datasets[0].data = [stats.approved || 0, stats.pending || 0, stats.rejected || 0];
                reviewStatusChart.update();
            }

            // Render top reviewed products
            renderTopReviewedProducts(topProducts);
        }

        function renderTopReviewedProducts(products) {
            const container = document.getElementById('top-reviewed-products');
            if (!products || products.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Chưa có dữ liệu</p>';
                return;
            }

            const maxCount = Math.max(...products.map(p => p.review_count || 0));
            container.innerHTML = products.map((p, i) => {
                const avgRating = parseFloat(p.avg_rating || 0).toFixed(1);
                return `
                    <div class="product-row">
                        <span class="w-7 h-7 rounded-full bg-gradient-to-br from-yellow-500 to-orange-500 text-white text-xs font-bold flex items-center justify-center mr-3">${i + 1}</span>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-800 truncate" title="${p.ten_mon}">${p.ten_mon}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <div class="flex-1 bg-slate-100 rounded-full h-2">
                                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 h-2 rounded-full" style="width: ${maxCount > 0 ? (p.review_count/maxCount)*100 : 0}%"></div>
                                </div>
                                <span class="text-xs text-yellow-600"><i class="fas fa-star"></i> ${avgRating}</span>
                            </div>
                        </div>
                        <span class="text-sm font-semibold text-orange-600 ml-2">${p.review_count}</span>
                    </div>
                `;
            }).join('');
        }

        function renderTopNews(newsData) {
            const container = document.getElementById('top-news');
            if (!newsData || newsData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Chưa có bài viết</p>';
                return;
            }
            const maxViews = Math.max(...newsData.map(n => n.luot_xem || 0));
            container.innerHTML = newsData.map((news, i) => `
                <div class="product-row">
                    <span class="w-7 h-7 rounded-full bg-gradient-to-br from-pink-500 to-rose-600 text-white text-xs font-bold flex items-center justify-center mr-3">${i + 1}</span>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800 truncate" title="${news.tieu_de}">${news.tieu_de}</p>
                        <div class="w-full bg-slate-100 rounded-full h-2 mt-1">
                            <div class="bg-gradient-to-r from-pink-500 to-rose-600 h-2 rounded-full transition-all" style="width: ${maxViews > 0 ? (news.luot_xem/maxViews)*100 : 0}%"></div>
                        </div>
                    </div>
                    <span class="text-sm font-semibold text-pink-600 ml-3">${formatNumber(news.luot_xem || 0)}</span>
                </div>
            `).join('');
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function updateGaugeChart(actual, target) {
            const percentage = Math.min(100, Math.round((actual / target) * 100));
            gaugeChart.data.datasets[0].data = [percentage, 100 - percentage];
            gaugeChart.update();
            document.getElementById('gauge-value').textContent = percentage + '%';
        }

        function updateOrdersChart(statusData) {
            const statusMap = { delivered: 0, preparing: 0, confirmed: 0, pending: 0, cancelled: 0 };
            statusData.forEach(s => { statusMap[s.trang_thai] = s.count; });
            ordersChart.data.datasets[0].data = [statusMap.delivered, statusMap.preparing + statusMap.confirmed, statusMap.pending, statusMap.cancelled];
            ordersChart.update();
        }

        async function renderTopProducts() {
            const container = document.getElementById('top-products');
            try {
                const response = await fetch(`${API_BASE}/stats/top-products`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.length > 0) {
                        const products = data.data;
                        const maxSold = Math.max(...products.map(p => p.da_ban || 0));
                        container.innerHTML = products.map((p, i) => `
                            <div class="product-row">
                                <span class="w-7 h-7 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white text-xs font-bold flex items-center justify-center mr-3">${i + 1}</span>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-800 truncate">${p.ten_mon}</p>
                                    <div class="w-full bg-slate-100 rounded-full h-2 mt-1">
                                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all" style="width: ${maxSold > 0 ? (p.da_ban/maxSold)*100 : 0}%"></div>
                                    </div>
                                </div>
                                <span class="text-sm font-semibold text-blue-600 ml-3">${p.da_ban || 0}</span>
                            </div>
                        `).join('');
                        return;
                    }
                }
            } catch (error) {
                console.error('Error loading top products:', error);
            }
            container.innerHTML = '<p class="text-center text-gray-500 py-4">Chưa có dữ liệu</p>';
        }

        async function renderRecentOrders() {
            const container = document.getElementById('recent-orders');
            const statusColors = { delivered: 'bg-emerald-100 text-emerald-700', confirmed: 'bg-blue-100 text-blue-700', preparing: 'bg-blue-100 text-blue-700', pending: 'bg-amber-100 text-amber-700', cancelled: 'bg-red-100 text-red-700' };
            const statusText = { delivered: 'Hoàn thành', confirmed: 'Đã xác nhận', preparing: 'Đang chuẩn bị', pending: 'Chờ xác nhận', cancelled: 'Đã hủy' };
            
            try {
                const response = await fetch(`${API_BASE}/orders/all?limit=5`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(o => `
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition">
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-800">#DH${String(o.ma_don_hang).padStart(6, '0')} - ${o.ten_khach_hang || o.ten_khach_vang_lai || 'Khách hàng'}</p>
                                    <p class="text-xs text-gray-500 mt-0.5">${formatTimeAgo(o.thoi_gian_tao)}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-bold text-blue-600">${formatCurrency(o.tong_tien || 0)}đ</p>
                                    <span class="text-xs px-2 py-1 rounded-full ${statusColors[o.trang_thai] || 'bg-gray-100 text-gray-700'} font-medium">${statusText[o.trang_thai] || o.trang_thai}</span>
                                </div>
                            </div>
                        `).join('');
                        return;
                    }
                }
            } catch (error) {
                console.error('Error loading recent orders:', error);
            }
            container.innerHTML = '<p class="text-center text-gray-500 py-4">Chưa có đơn hàng</p>';
        }

        function formatTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Vừa xong';
            if (diffMins < 60) return `${diffMins} phút trước`;
            if (diffHours < 24) return `${diffHours} giờ trước`;
            if (diffDays < 7) return `${diffDays} ngày trước`;
            return date.toLocaleDateString('vi-VN');
        }

        function formatCurrency(value) { return new Intl.NumberFormat('vi-VN').format(value); }

        // Lấy giá trị filter hiện tại
        function getFilterValues() {
            const yearBtn = document.querySelector('.filter-btn[data-year].active');
            const monthBtn = document.querySelector('.filter-btn[data-month].active');
            const statusBtn = document.querySelector('.filter-btn[data-status].active');
            
            return {
                year: yearBtn ? parseInt(yearBtn.dataset.year) : new Date().getFullYear(),
                month: monthBtn ? parseInt(monthBtn.dataset.month) : 0, // 0 = All
                status: statusBtn ? statusBtn.dataset.status : 'all'
            };
        }

        function initFilters() {
            document.querySelectorAll('.filter-group').forEach(group => {
                group.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Lấy filter values và load lại data
                        const filters = getFilterValues();
                        console.log('Filters changed:', filters);
                        loadDashboardDataWithFilters(filters);
                    });
                });
            });
        }

        async function loadDashboardDataWithFilters(filters) {
            try {
                // Build query params
                const params = new URLSearchParams();
                if (filters.year) params.append('year', filters.year);
                if (filters.month && filters.month > 0) params.append('month', filters.month);
                if (filters.status && filters.status !== 'all') params.append('status', filters.status);
                
                const queryString = params.toString() ? `?${params.toString()}` : '';

                // Load dữ liệu với filter
                const [ordersRes, revenueMonthlyRes] = await Promise.all([
                    fetch(`${API_BASE}/orders/stats${queryString}`, { credentials: 'include' }).catch(() => null),
                    fetch(`${API_BASE}/stats/revenue-monthly${queryString}`, { credentials: 'include' }).catch(() => null)
                ]);

                // Cập nhật KPI Cards
                if (ordersRes && ordersRes.ok) {
                    const data = await ordersRes.json();
                    if (data.success !== false) {
                        document.getElementById('total-revenue').textContent = formatCurrency(data.totalRevenue || 0) + 'đ';
                        document.getElementById('total-orders').textContent = data.totalOrders || 0;
                        updateGaugeChart(data.totalRevenue || 0, 100000000);
                        updateOrdersChart(data.byStatus || []);
                    }
                }

                // Cập nhật biểu đồ doanh thu
                if (revenueMonthlyRes && revenueMonthlyRes.ok) {
                    const data = await revenueMonthlyRes.json();
                    if (data.success && data.data) {
                        updateRevenueChartWithYear(data.data, filters.year);
                    }
                }

                // Load lại recent orders với filter status
                await renderRecentOrdersWithFilter(filters.status);

            } catch (error) {
                console.error('Error loading filtered data:', error);
            }
        }

        function updateRevenueChartWithYear(data, year) {
            const monthlyData = new Array(12).fill(0);
            
            data.forEach(item => {
                if (item.nam === year && item.thang >= 1 && item.thang <= 12) {
                    monthlyData[item.thang - 1] = Math.round((item.doanh_thu || 0) / 1000000);
                }
            });

            revenueChart.data.datasets[0].data = monthlyData;
            revenueChart.update();
        }

        async function renderRecentOrdersWithFilter(status) {
            const container = document.getElementById('recent-orders');
            const statusColors = { delivered: 'bg-emerald-100 text-emerald-700', confirmed: 'bg-blue-100 text-blue-700', preparing: 'bg-blue-100 text-blue-700', pending: 'bg-amber-100 text-amber-700', cancelled: 'bg-red-100 text-red-700' };
            const statusText = { delivered: 'Hoàn thành', confirmed: 'Đã xác nhận', preparing: 'Đang chuẩn bị', pending: 'Chờ xác nhận', cancelled: 'Đã hủy' };
            
            try {
                let url = `${API_BASE}/orders/all?limit=5`;
                if (status && status !== 'all') {
                    url += `&status=${status}`;
                }
                
                const response = await fetch(url, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = data.data.map(o => `
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition">
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-800">#DH${String(o.ma_don_hang).padStart(6, '0')} - ${o.ten_khach_hang || o.ten_khach_vang_lai || 'Khách hàng'}</p>
                                    <p class="text-xs text-gray-500 mt-0.5">${formatTimeAgo(o.thoi_gian_tao)}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-bold text-blue-600">${formatCurrency(o.tong_tien || 0)}đ</p>
                                    <span class="text-xs px-2 py-1 rounded-full ${statusColors[o.trang_thai] || 'bg-gray-100 text-gray-700'} font-medium">${statusText[o.trang_thai] || o.trang_thai}</span>
                                </div>
                            </div>
                        `).join('');
                        return;
                    }
                }
            } catch (error) {
                console.error('Error loading recent orders:', error);
            }
            container.innerHTML = '<p class="text-center text-gray-500 py-4">Không có đơn hàng phù hợp</p>';
        }
    </script>
</body>
</html>
