<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·∫∑t h√†ng th√†nh c√¥ng - Nh√† h√†ng Ph∆∞∆°ng Nam Vƒ©nh Long</title>
    <link rel="icon" type="image/png" href="images/Green Simple Clean Vegan Food Logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/modern-style.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>

<body class="bg-gradient-to-br from-orange-50 via-red-50 to-yellow-50">
    <!-- Navigation Container -->
    <div id="navbar-container"></div>

    <!-- Success Content -->
    <section class="py-20">
        <div class="container mx-auto px-4">
            <div class="max-w-2xl mx-auto">
                <!-- Success Card -->
                <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
                    <!-- Success Icon -->
                    <div class="mb-6">
                        <div
                            class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto animate-bounce">
                            <i class="fas fa-check-circle text-5xl text-green-600"></i>
                        </div>
                    </div>

                    <!-- Success Message -->
                    <h1 class="text-3xl font-bold text-gray-800 mb-3">
                        ƒê·∫∑t h√†ng th√†nh c√¥ng!
                    </h1>
                    <p class="text-gray-600 mb-6">
                        C·∫£m ∆°n b·∫°n ƒë√£ ƒë·∫∑t h√†ng t·∫°i Nh√† h√†ng Ph∆∞∆°ng Nam
                    </p>

                    <!-- Order Info -->
                    <div class="bg-orange-50 rounded-lg p-6 mb-8">
                        <div class="flex items-center justify-center mb-4">
                            <i class="fas fa-receipt text-2xl text-orange-600 mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">M√£ ƒë∆°n h√†ng</p>
                                <p class="text-xl font-bold text-orange-600" id="order-code">Loading...</p>
                            </div>
                        </div>
                        <div class="border-t border-orange-200 pt-4">
                            <p class="text-sm text-gray-600 mb-2">
                                <i class="fas fa-info-circle mr-2"></i>
                                Ch√∫ng t√¥i ƒë√£ g·ª≠i x√°c nh·∫≠n ƒë∆°n h√†ng qua email c·ªßa b·∫°n
                            </p>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-truck mr-2"></i>
                                ƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c giao trong v√≤ng 30-45 ph√∫t
                            </p>
                        </div>
                    </div>

                    <!-- Order Details -->
                    <div class="bg-gray-50 rounded-lg p-6 mb-8 text-left" id="order-details">
                        <h3 class="font-bold text-lg mb-4 text-center">
                            <i class="fas fa-clipboard-list mr-2"></i>
                            Chi ti·∫øt ƒë∆°n h√†ng
                        </h3>
                        <div id="order-items" class="space-y-3 mb-4">
                            <!-- Items will be loaded here -->
                        </div>
                        <div class="border-t pt-4">
                            <div class="flex justify-between text-gray-600 mb-2">
                                <span>T·∫°m t√≠nh</span>
                                <span id="subtotal">0ƒë</span>
                            </div>
                            <div class="flex justify-between text-gray-600 mb-2">
                                <span>Ph√≠ giao h√†ng</span>
                                <span id="shipping">0ƒë</span>
                            </div>
                            <div class="flex justify-between font-bold text-lg text-orange-600">
                                <span>T·ªïng c·ªông</span>
                                <span id="total">0ƒë</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <a href="index.html"
                            class="flex-1 bg-orange-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-orange-700 transition inline-flex items-center justify-center">
                            <i class="fas fa-home mr-2"></i>
                            V·ªÅ trang ch·ªß
                        </a>
                        <a href="thuc-don.html"
                            class="flex-1 bg-white border-2 border-orange-600 text-orange-600 py-3 px-6 rounded-lg font-medium hover:bg-orange-50 transition inline-flex items-center justify-center">
                            <i class="fas fa-utensils mr-2"></i>
                            ƒê·∫∑t th√™m m√≥n
                        </a>
                    </div>

                    <!-- Contact Info -->
                    <div class="mt-8 pt-6 border-t">
                        <p class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-question-circle mr-2"></i>
                            C·∫ßn h·ªó tr·ª£? Li√™n h·ªá v·ªõi ch√∫ng t√¥i
                        </p>
                        <div class="flex items-center justify-center space-x-6 text-sm">
                            <a href="tel:0123456789" class="text-orange-600 hover:underline" data-setting-href="tel:" data-setting-value="so_dien_thoai">
                                <i class="fas fa-phone mr-1"></i>
                                <span data-setting="so_dien_thoai">0123 456 789</span>
                            </a>
                            <a href="mailto:support@phuongnam.vn" class="text-orange-600 hover:underline" data-setting-href="mailto:" data-setting-value="email">
                                <i class="fas fa-envelope mr-1"></i>
                                <span data-setting="email">support@phuongnam.vn</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Suggested Products -->
                <div class="mt-8 bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="font-bold text-lg mb-4 text-center">
                        <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                        C√≥ th·ªÉ b·∫°n c≈©ng th√≠ch
                    </h3>
                    <div id="suggested-products" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- Products will be loaded here -->
                        <div class="col-span-full text-center py-4 text-gray-400">
                            <i class="fas fa-spinner fa-spin mr-2"></i>ƒêang t·∫£i...
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="mt-8 bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="font-bold text-lg mb-4 text-center">
                        <i class="fas fa-history mr-2"></i>
                        Quy tr√¨nh giao h√†ng
                    </h3>
                    <div class="flex justify-between items-center">
                        <div class="flex-1 text-center">
                            <div
                                class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fas fa-check text-green-600"></i>
                            </div>
                            <p class="text-xs font-medium">ƒê√£ ƒë·∫∑t h√†ng</p>
                        </div>
                        <div class="flex-1 border-t-2 border-dashed border-gray-300"></div>
                        <div class="flex-1 text-center">
                            <div
                                class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fas fa-fire text-orange-600"></i>
                            </div>
                            <p class="text-xs font-medium">ƒêang chu·∫©n b·ªã</p>
                        </div>
                        <div class="flex-1 border-t-2 border-dashed border-gray-300"></div>
                        <div class="flex-1 text-center">
                            <div
                                class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fas fa-shipping-fast text-gray-400"></i>
                            </div>
                            <p class="text-xs font-medium">ƒêang giao</p>
                        </div>
                        <div class="flex-1 border-t-2 border-dashed border-gray-300"></div>
                        <div class="flex-1 text-center">
                            <div
                                class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fas fa-star text-gray-400"></i>
                            </div>
                            <p class="text-xs font-medium">Ho√†n th√†nh</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer Container -->
    <div id="footer-container"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="js/loading.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script src="js/load-components.js"></script>

    <script>
        // API Configuration
        const API_URL = window.API_URL || 'http://localhost:3000/api';

        // Get token
        function getToken() {
            return localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        // Get order ID from URL
        function getOrderId() {
            const urlParams = new URLSearchParams(window.location.search);
            // Try both 'orderId' and 'order' parameters
            return urlParams.get('orderId') || urlParams.get('order');
        }

        // Load order details
        async function loadOrderDetails() {
            const orderId = getOrderId();
            const orderCodeEl = document.getElementById('order-code');

            console.log('üîç Order ID from URL:', orderId);

            if (!orderId) {
                console.error('‚ùå No order ID found in URL');
                orderCodeEl.textContent = 'Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng';
                return;
            }

            orderCodeEl.textContent = `DH${String(orderId).padStart(6, '0')}`;

            try {
                const token = getToken();
                console.log('üîë Token:', token ? 'Found' : 'Not found');
                
                const url = `${API_URL}/orders/${orderId}`;
                console.log('üì° Fetching:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('üì• Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('üì¶ Order data:', result);
                    
                    if (result.success) {
                        displayOrderDetails(result.data);
                    } else {
                        console.error('‚ùå API returned success=false:', result.message);
                        orderCodeEl.textContent = result.message || 'Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng';
                    }
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå API error:', response.status, errorText);
                    orderCodeEl.textContent = 'L·ªói khi t·∫£i ƒë∆°n h√†ng';
                }
            } catch (error) {
                console.error('‚ùå Error loading order:', error);
                orderCodeEl.textContent = 'L·ªói k·∫øt n·ªëi';
            }
        }

        // Display order details
        function displayOrderDetails(order) {
            const itemsContainer = document.getElementById('order-items');
            const subtotalEl = document.getElementById('subtotal');
            const shippingEl = document.getElementById('shipping');
            const totalEl = document.getElementById('total');

            if (order.items && order.items.length > 0) {
                itemsContainer.innerHTML = order.items.map(item => `
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">
                            <span class="font-medium">${item.ten_mon}</span>
                            <span class="text-gray-400"> x${item.so_luong}</span>
                        </span>
                        <span class="font-medium">${formatCurrency(item.thanh_tien)}</span>
                    </div>
                `).join('');
            }

            const subtotal = order.tong_tien_hang || 0;
            const shipping = order.phi_van_chuyen || 0;
            const total = order.tong_thanh_toan || 0;

            if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
            if (shippingEl) shippingEl.textContent = shipping === 0 ? 'Mi·ªÖn ph√≠' : formatCurrency(shipping);
            if (totalEl) totalEl.textContent = formatCurrency(total);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function () {
            // Clear cart after successful payment
            const urlParams = new URLSearchParams(window.location.search);
            const payment = urlParams.get('payment');
            const status = urlParams.get('status');
            const orderId = getOrderId();

            // X√≥a gi·ªè h√†ng khi ƒë·∫∑t h√†ng th√†nh c√¥ng
            if (orderId) {
                console.log('‚úÖ Order successful, marking cart as ordered...');
                try {
                    const token = getToken();
                    if (token) {
                        // G·ªçi API ƒë·ªÉ ƒë√°nh d·∫•u gi·ªè h√†ng ƒë√£ ƒë·∫∑t (t·∫°o gi·ªè m·ªõi cho user)
                        const response = await fetch(`${API_URL}/cart/mark-ordered`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        const result = await response.json();
                        console.log('üì¶ Mark cart ordered result:', result);
                        
                        // Reload cart trong cartManager ƒë·ªÉ c·∫≠p nh·∫≠t UI
                        if (typeof cartManager !== 'undefined') {
                            await cartManager.loadCart();
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error marking cart as ordered:', error);
                }
                
                // X√≥a localStorage cart backup
                localStorage.removeItem('cart');
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (user.ma_nguoi_dung) {
                    localStorage.removeItem(`cart_${user.ma_nguoi_dung}`);
                }
            }

            loadOrderDetails();
            loadSuggestedProducts();
        });

        // Load suggested products
        async function loadSuggestedProducts() {
            try {
                const response = await fetch(`${API_URL}/menu?limit=8&sort=random`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    displaySuggestedProducts(result.data.slice(0, 4));
                } else {
                    // Fallback: load popular items
                    const fallbackResponse = await fetch(`${API_URL}/menu?limit=4`);
                    const fallbackResult = await fallbackResponse.json();
                    if (fallbackResult.success && fallbackResult.data) {
                        displaySuggestedProducts(fallbackResult.data.slice(0, 4));
                    }
                }
            } catch (error) {
                console.error('Error loading suggested products:', error);
                document.getElementById('suggested-products').innerHTML = `
                    <div class="col-span-full text-center py-4">
                        <a href="thuc-don.html" class="text-orange-600 hover:underline">
                            <i class="fas fa-utensils mr-2"></i>Xem th·ª±c ƒë∆°n
                        </a>
                    </div>
                `;
            }
        }

        // Display suggested products
        function displaySuggestedProducts(products) {
            const container = document.getElementById('suggested-products');
            
            container.innerHTML = products.map(product => {
                // X·ª≠ l√Ω ƒë∆∞·ªùng d·∫´n ·∫£nh
                let imagePath = product.anh_mon || 'images/placeholder-food.jpg';
                if (imagePath && !imagePath.startsWith('http') && !imagePath.startsWith('/')) {
                    imagePath = '/images/' + imagePath;
                }
                const imageUrl = imagePath.startsWith('http') ? imagePath : `http://localhost:3000${imagePath}`;
                
                // X·ª≠ l√Ω gi√° an to√†n - tr√°nh NaN
                const price = product.gia_tien ? parseFloat(product.gia_tien) : 0;
                const formattedPrice = !isNaN(price) ? formatCurrency(price) : 'Li√™n h·ªá';
                
                return `
                    <a href="chitietmonan.html?id=${product.ma_mon}" class="group block">
                        <div class="bg-gray-100 rounded-lg overflow-hidden aspect-square mb-2">
                            <img src="${imageUrl}" 
                                 alt="${product.ten_mon}"
                                 class="w-full h-full object-cover group-hover:scale-105 transition duration-300"
                                 onerror="this.src='images/placeholder-food.jpg'">
                        </div>
                        <h4 class="text-sm font-medium text-gray-800 truncate group-hover:text-orange-600 transition">${product.ten_mon}</h4>
                        <p class="text-sm font-bold text-orange-600">${formattedPrice}</p>
                    </a>
                `;
            }).join('');
        }
    </script>
    
    <!-- Snow Effect -->
    <script src="js/snow-effect.js"></script>
    
    <!-- Responsive Helper -->
    <script src="js/responsive-helper.js"></script>
</body>

</html>