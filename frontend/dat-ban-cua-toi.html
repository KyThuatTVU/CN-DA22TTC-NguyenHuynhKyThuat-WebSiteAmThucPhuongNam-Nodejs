<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt bàn của tôi - Nhà hàng Phương Nam Vĩnh Long</title>
    <link rel="icon" type="image/png" href="images/Green Simple Clean Vegan Food Logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/modern-style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/loading.css">
</head>
<body class="bg-gradient-to-br from-orange-50 via-red-50 to-yellow-50">
    <!-- Navigation Container -->
    <div id="navbar-container"></div>

    <!-- My Reservations Content -->
    <section class="py-12 min-h-screen">
        <div class="container mx-auto px-4">
            <!-- Page Header -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">
                            <i class="fas fa-calendar-check text-orange-600 mr-3"></i>
                            Đặt bàn của tôi
                        </h1>
                        <p class="text-gray-600">Quản lý và theo dõi đặt bàn của bạn</p>
                    </div>
                    <button onclick="loadReservations()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Làm mới
                    </button>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
                <div class="flex flex-wrap gap-2">
                    <button onclick="filterReservations('all')" class="filter-btn active px-4 py-2 rounded-lg font-medium transition" data-status="all">
                        <i class="fas fa-list mr-2"></i>Tất cả
                    </button>
                    <button onclick="filterReservations('pending')" class="filter-btn px-4 py-2 rounded-lg font-medium transition" data-status="pending">
                        <i class="fas fa-clock mr-2"></i>Chờ xác nhận
                    </button>
                    <button onclick="filterReservations('confirmed')" class="filter-btn px-4 py-2 rounded-lg font-medium transition" data-status="confirmed">
                        <i class="fas fa-check-circle mr-2"></i>Đã xác nhận
                    </button>
                    <button onclick="filterReservations('attended')" class="filter-btn px-4 py-2 rounded-lg font-medium transition" data-status="attended">
                        <i class="fas fa-star mr-2"></i>Đã đến
                    </button>
                    <button onclick="filterReservations('cancelled')" class="filter-btn px-4 py-2 rounded-lg font-medium transition" data-status="cancelled">
                        <i class="fas fa-times-circle mr-2"></i>Đã hủy
                    </button>
                </div>
            </div>

            <!-- Reservations List -->
            <div id="reservations-container" class="space-y-4">
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-orange-600 mb-4"></i>
                    <p class="text-gray-600">Đang tải đặt bàn...</p>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden bg-white rounded-xl shadow-sm p-12 text-center">
                <i class="fas fa-calendar-times text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Chưa có đặt bàn nào</h3>
                <p class="text-gray-600 mb-6">Hãy đặt bàn trước để được phục vụ tốt nhất</p>
                <a href="dat-ban.html" class="inline-block bg-orange-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-orange-700 transition">
                    <i class="fas fa-calendar-plus mr-2"></i>
                    Đặt bàn ngay
                </a>
            </div>
        </div>
    </section>

    <!-- Footer Container -->
    <div id="footer-container"></div>

    <script src="js/loading.js"></script>
    <script src="js/main.js"></script>
    <script src="js/load-components.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/reservation-payment.js"></script>

    <script>
        const API_URL = window.API_URL || 'http://localhost:3000/api';
        let allReservations = [];
        let currentFilter = 'all';

        // Check login on page load
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'dang-nhap.html?redirect=dat-ban-cua-toi.html';
                return;
            }
            loadReservations();
        });

        // Load reservations
        async function loadReservations() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/reservations/my-reservations`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    allReservations = result.data;
                    renderReservations(allReservations);
                } else {
                    showNotification(result.message || 'Không thể tải đặt bàn', 'error');
                }
            } catch (error) {
                console.error('Error loading reservations:', error);
                showNotification('Lỗi kết nối server', 'error');
            }
        }

        // Filter reservations
        function filterReservations(status) {
            currentFilter = status;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-orange-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('active', 'bg-orange-600', 'text-white');

            // Filter data
            const filtered = status === 'all' 
                ? allReservations 
                : allReservations.filter(r => r.trang_thai === status);
            
            renderReservations(filtered);
        }

        // Render reservations
        function renderReservations(reservations) {
            const container = document.getElementById('reservations-container');
            const emptyState = document.getElementById('empty-state');

            if (reservations.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = reservations.map(reservation => {
                const statusInfo = getStatusInfo(reservation.trang_thai);
                const paymentStatusInfo = getPaymentStatusInfo(reservation.trang_thai_thanh_toan);
                const date = new Date(reservation.ngay_dat).toLocaleDateString('vi-VN');
                
                return `
                    <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                            <div>
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-xl font-bold text-gray-800">
                                        Mã đặt bàn: #${String(reservation.ma_dat_ban).padStart(6, '0')}
                                    </h3>
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${statusInfo.class}">
                                        ${statusInfo.text}
                                    </span>
                                    ${paymentStatusInfo ? `
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${paymentStatusInfo.class}">
                                            ${paymentStatusInfo.text}
                                        </span>
                                    ` : ''}
                                </div>
                                <p class="text-gray-600">
                                    <i class="fas fa-calendar mr-2"></i>${date} lúc ${reservation.gio_den}
                                </p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Tổng dự kiến</p>
                                <p class="text-2xl font-bold text-orange-600">${formatPrice(reservation.tong_tien_du_kien)}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <p class="text-sm text-gray-600">Tên người đặt</p>
                                <p class="font-medium">${reservation.ten_nguoi_dat}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Số điện thoại</p>
                                <p class="font-medium">${reservation.so_dien_thoai}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Số lượng khách</p>
                                <p class="font-medium">${reservation.so_luong} người</p>
                            </div>
                        </div>

                        ${reservation.mon_an && reservation.mon_an.length > 0 ? `
                            <div class="mb-4">
                                <p class="font-medium text-gray-700 mb-2">
                                    <i class="fas fa-utensils mr-2"></i>Món ăn đã đặt (${reservation.mon_an.length} món):
                                </p>
                                <div class="space-y-2">
                                    ${reservation.mon_an.map(item => `
                                        <div class="flex justify-between items-center text-sm">
                                            <span class="text-gray-700">${item.ten_mon} x${item.so_luong}</span>
                                            <span class="font-medium">${formatPrice(item.gia_tai_thoi_diem * item.so_luong)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${reservation.ghi_chu ? `
                            <div class="mb-4 p-3 bg-yellow-50 rounded-lg">
                                <p class="text-sm text-gray-700">
                                    <i class="fas fa-sticky-note mr-2 text-yellow-600"></i>
                                    <strong>Ghi chú:</strong> ${reservation.ghi_chu}
                                </p>
                            </div>
                        ` : ''}

                        <div class="flex flex-wrap gap-2">
                            ${(reservation.trang_thai_thanh_toan === 'unpaid' || reservation.trang_thai_thanh_toan === 'pending' || reservation.trang_thai_thanh_toan === 'failed' || reservation.trang_thai_thanh_toan === 'cancelled') && reservation.trang_thai !== 'cancelled' ? `
                                <button onclick="showReservationPaymentQR(${reservation.ma_dat_ban})" 
                                        class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                    <i class="fas fa-qrcode mr-2"></i>Thanh toán ngay
                                </button>
                            ` : ''}
                            ${reservation.trang_thai === 'pending' || reservation.trang_thai === 'confirmed' ? `
                                <button onclick="cancelReservation(${reservation.ma_dat_ban})" 
                                        class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                                    <i class="fas fa-times mr-2"></i>Hủy đặt bàn
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get status info
        function getStatusInfo(status) {
            const statusMap = {
                'pending': { text: 'Chờ xác nhận', class: 'bg-yellow-100 text-yellow-800' },
                'confirmed': { text: 'Đã xác nhận', class: 'bg-green-100 text-green-800' },
                'attended': { text: 'Đã đến', class: 'bg-blue-100 text-blue-800' },
                'cancelled': { text: 'Đã hủy', class: 'bg-red-100 text-red-800' }
            };
            return statusMap[status] || { text: status, class: 'bg-gray-100 text-gray-800' };
        }

        // Get payment status info
        function getPaymentStatusInfo(status) {
            const statusMap = {
                'unpaid': { text: 'Chưa thanh toán', class: 'bg-orange-100 text-orange-800' },
                'pending': { text: 'Chờ thanh toán', class: 'bg-yellow-100 text-yellow-800' },
                'paid': { text: 'Đã thanh toán', class: 'bg-green-100 text-green-800' },
                'failed': { text: 'Hết hạn thanh toán', class: 'bg-red-100 text-red-800' },
                'cancelled': { text: 'Đã hủy thanh toán', class: 'bg-gray-100 text-gray-800' }
            };
            return statusMap[status] || null;
        }

        // Cancel reservation
        async function cancelReservation(maDatBan) {
            if (!confirm('Bạn có chắc chắn muốn hủy đặt bàn này?')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/reservations/${maDatBan}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Đã hủy đặt bàn thành công', 'success');
                    loadReservations();
                } else {
                    showNotification(result.message || 'Không thể hủy đặt bàn', 'error');
                }
            } catch (error) {
                console.error('Error cancelling reservation:', error);
                showNotification('Lỗi kết nối server', 'error');
            }
        }

        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', { 
                style: 'currency', 
                currency: 'VND' 
            }).format(price);
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                            type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = type === 'success' ? 'fa-check-circle' : 
                         type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            
            notification.className = `fixed top-6 right-6 z-50 px-6 py-4 rounded-lg shadow-lg ${bgColor} text-white`;
            notification.innerHTML = `<i class="fas ${icon} mr-2"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
</body>
</html>
