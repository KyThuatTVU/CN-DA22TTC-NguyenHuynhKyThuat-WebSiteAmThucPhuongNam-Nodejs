<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√†i Kho·∫£n C·ªßa T√¥i - Nh√† h√†ng ·∫®m th·ª±c Ph∆∞∆°ng Nam</title>
    <link rel="icon" type="image/png" href="images/Green Simple Clean Vegan Food Logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/modern-style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/loading.css">
    <script src="js/tailwind-config.js"></script>
</head>

<body class="bg-gray-50">
    <!-- Navbar Container -->
    <div id="navbar-container"></div>

    <!-- Account Page -->
    <div class="min-h-screen pt-24 pb-16">
        <div class="container mx-auto px-4 max-w-7xl">
            <!-- Page Header -->
            <div class="mb-6 sm:mb-8">
                <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-user-circle text-orange-600 mr-2 sm:mr-3"></i>
                    T√†i Kho·∫£n C·ªßa T√¥i
                </h1>
                <p class="text-gray-600 text-sm sm:text-base">Qu·∫£n l√Ω th√¥ng tin c√° nh√¢n v√† c√†i ƒë·∫∑t t√†i kho·∫£n</p>
            </div>

            <div class="grid lg:grid-cols-4 gap-6">
                <!-- Mobile Menu Toggle -->
                <button id="mobile-menu-toggle" class="lg:hidden w-full bg-white rounded-lg shadow-md p-4 flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-bars text-orange-600 text-xl"></i>
                        <span class="font-semibold text-gray-800">Menu T√†i Kho·∫£n</span>
                    </div>
                    <i class="fas fa-chevron-down text-gray-600 transition-transform" id="menu-chevron"></i>
                </button>

                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <div id="sidebar-menu" class="bg-white rounded-lg shadow-md p-4 sm:p-6 lg:sticky lg:top-24 hidden lg:block">
                        <!-- User Avatar -->
                        <div class="text-center mb-4 sm:mb-6">
                            <div class="relative inline-block">
                                <div id="avatar-display" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center text-white text-2xl sm:text-3xl font-bold mx-auto shadow-lg transition-all duration-300 hover:scale-105">
                                    <i class="fas fa-user"></i>
                                </div>
                                <button onclick="document.getElementById('avatar-input').click()" class="absolute bottom-0 right-0 bg-orange-600 text-white w-8 h-8 rounded-full hover:bg-orange-700 hover:scale-110 transition-all duration-300 shadow-md flex items-center justify-center">
                                    <i class="fas fa-camera text-sm"></i>
                                </button>
                                <input type="file" id="avatar-input" accept="image/*" class="hidden">
                                <div id="upload-loading" class="hidden absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center">
                                    <i class="fas fa-spinner fa-spin text-white text-2xl"></i>
                                </div>
                            </div>
                            <h3 id="sidebar-username" class="text-xl font-bold text-gray-800 mt-4">
                                <span class="inline-block animate-pulse bg-gray-200 h-6 w-32 rounded" style="display: none;"></span>
                            </h3>
                            <p id="sidebar-email" class="text-sm text-gray-600">
                                <span class="inline-block animate-pulse bg-gray-200 h-4 w-40 rounded" style="display: none;"></span>
                            </p>
                        </div>

                        <!-- Navigation Menu -->
                        <nav class="space-y-2">
                            <button onclick="showTab('profile', event)" class="tab-button w-full text-left px-4 py-3 rounded-lg hover:bg-orange-50 hover:text-orange-600 transition flex items-center gap-3 bg-orange-50 text-orange-600 font-semibold">
                                <i class="fas fa-user w-5"></i>
                                <span>Th√¥ng tin c√° nh√¢n</span>
                            </button>
                            <button onclick="showTab('password', event)" class="tab-button w-full text-left px-4 py-3 rounded-lg hover:bg-orange-50 hover:text-orange-600 transition flex items-center gap-3">
                                <i class="fas fa-lock w-5"></i>
                                <span>ƒê·ªïi m·∫≠t kh·∫©u</span>
                            </button>
                            <a href="don-hang-cua-toi.html" class="tab-button w-full text-left px-4 py-3 rounded-lg hover:bg-orange-50 hover:text-orange-600 transition flex items-center gap-3 block">
                                <i class="fas fa-shopping-bag w-5"></i>
                                <span>ƒê∆°n h√†ng</span>
                            </a>
                            <button onclick="showTab('reservations', event)" class="tab-button w-full text-left px-4 py-3 rounded-lg hover:bg-orange-50 hover:text-orange-600 transition flex items-center gap-3">
                                <i class="fas fa-calendar-check w-5"></i>
                                <span>ƒê·∫∑t b√†n</span>
                            </button>
                            <button onclick="showTab('notifications', event)" class="tab-button w-full text-left px-4 py-3 rounded-lg hover:bg-orange-50 hover:text-orange-600 transition flex items-center gap-3">
                                <i class="fas fa-bell w-5"></i>
                                <span>Th√¥ng b√°o</span>
                                <span id="sidebar-notification-badge" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                            </button>
                            <hr class="my-4">
                            <button onclick="handleLogout()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 text-red-600 hover:text-red-700 transition flex items-center gap-3">
                                <i class="fas fa-sign-out-alt w-5"></i>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="lg:col-span-3">
                    <!-- Profile Tab -->
                    <div id="profile-tab" class="tab-content">
                        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 md:p-8">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-800">
                                    <i class="fas fa-user-edit text-orange-600 mr-2"></i>
                                    Th√¥ng Tin C√° Nh√¢n
                                </h2>
                                <button id="edit-profile-btn" onclick="toggleEditMode()" class="w-full sm:w-auto px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition text-sm sm:text-base">
                                    <i class="fas fa-edit mr-2"></i>Ch·ªânh s·ª≠a
                                </button>
                            </div>

                            <form id="profile-form" class="space-y-6">
                                <!-- Name -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-user mr-2 text-orange-600"></i>H·ªç v√† t√™n
                                    </label>
                                    <input type="text" id="ten_nguoi_dung" disabled
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed">
                                </div>

                                <!-- Email -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-envelope mr-2 text-orange-600"></i>Email
                                    </label>
                                    <input type="email" id="email" disabled
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed">
                                    <p class="text-xs text-gray-500 mt-1">Email kh√¥ng th·ªÉ thay ƒë·ªïi</p>
                                </div>

                                <!-- Phone -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-phone mr-2 text-orange-600"></i>S·ªë ƒëi·ªán tho·∫°i
                                    </label>
                                    <input type="tel" id="so_dien_thoai" disabled placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed">
                                </div>

                                <!-- Address -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-map-marker-alt mr-2 text-orange-600"></i>ƒê·ªãa ch·ªâ
                                    </label>
                                    <textarea id="dia_chi" disabled rows="3" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ c·ªßa b·∫°n"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"></textarea>
                                </div>

                                <!-- Gender -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-venus-mars mr-2 text-orange-600"></i>Gi·ªõi t√≠nh
                                    </label>
                                    <select id="gioi_tinh" disabled
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed">
                                        <option value="khac">Kh√°c</option>
                                        <option value="nam">Nam</option>
                                        <option value="nu">N·ªØ</option>
                                    </select>
                                </div>

                                <!-- Save Button (hidden by default) -->
                                <div id="save-buttons" class="hidden flex flex-col sm:flex-row gap-3 sm:gap-4">
                                    <button type="submit" class="flex-1 bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 active:scale-95 transition-all font-semibold">
                                        <i class="fas fa-save mr-2"></i>L∆∞u thay ƒë·ªïi
                                    </button>
                                    <button type="button" onclick="cancelEdit()" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 active:scale-95 transition-all font-semibold">
                                        <i class="fas fa-times mr-2"></i>H·ªßy
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Password Tab -->
                    <div id="password-tab" class="tab-content hidden">
                        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 md:p-8">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6">
                                <i class="fas fa-key text-orange-600 mr-2"></i>
                                ƒê·ªïi M·∫≠t Kh·∫©u
                            </h2>

                            <form id="password-form" class="space-y-6">
                                <!-- Current Password -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-lock mr-2 text-orange-600"></i>M·∫≠t kh·∫©u hi·ªán t·∫°i
                                    </label>
                                    <div class="relative">
                                        <input type="password" id="mat_khau_cu" required
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <button type="button" onclick="togglePassword('mat_khau_cu')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- New Password -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-lock mr-2 text-orange-600"></i>M·∫≠t kh·∫©u m·ªõi
                                    </label>
                                    <div class="relative">
                                        <input type="password" id="mat_khau_moi" required
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <button type="button" onclick="togglePassword('mat_khau_moi')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±, bao g·ªìm ch·ªØ v√† s·ªë</p>
                                </div>

                                <!-- Confirm Password -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-lock mr-2 text-orange-600"></i>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi
                                    </label>
                                    <div class="relative">
                                        <input type="password" id="xac_nhan_mat_khau" required
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <button type="button" onclick="togglePassword('xac_nhan_mat_khau')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <button type="submit" class="w-full bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 active:scale-95 transition-all font-semibold shadow-md">
                                    <i class="fas fa-check mr-2"></i>ƒê·ªïi m·∫≠t kh·∫©u
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Orders Tab - Redirects to dedicated page -->
                    <!-- This tab is no longer used as orders have their own page -->

                    <!-- Reservations Tab -->
                    <div id="reservations-tab" class="tab-content hidden">
                        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 md:p-8">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6">
                                <i class="fas fa-calendar-check text-orange-600 mr-2"></i>
                                L·ªãch ƒê·∫∑t B√†n
                            </h2>

                            <div id="reservations-list" class="space-y-4">
                                <!-- Reservations will be loaded here -->
                                <div class="text-center py-12 text-gray-500">
                                    <i class="fas fa-calendar-times text-6xl mb-4 opacity-30"></i>
                                    <p class="text-lg">B·∫°n ch∆∞a c√≥ l·ªãch ƒë·∫∑t b√†n n√†o</p>
                                    <a href="dat-ban.html" class="inline-block mt-4 text-orange-600 hover:text-orange-700 font-semibold">
                                        ƒê·∫∑t b√†n ngay <i class="fas fa-arrow-right ml-2"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notifications Tab -->
                    <div id="notifications-tab" class="tab-content hidden">
                        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 md:p-8">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-800">
                                    <i class="fas fa-bell text-orange-600 mr-2"></i>
                                    Th√¥ng B√°o
                                </h2>
                                <button id="mark-all-read-account" class="text-sm text-orange-600 hover:text-orange-700 font-medium">
                                    <i class="fas fa-check-double mr-1"></i>
                                    ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
                                </button>
                            </div>

                            <!-- Filter Tabs -->
                            <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                                <button onclick="filterNotifications('all')" class="notification-filter-btn active px-4 py-2 rounded-lg bg-orange-50 text-orange-600 font-medium text-sm whitespace-nowrap">
                                    T·∫•t c·∫£
                                </button>
                                <button onclick="filterNotifications('unread')" class="notification-filter-btn px-4 py-2 rounded-lg hover:bg-gray-100 text-gray-600 font-medium text-sm whitespace-nowrap">
                                    Ch∆∞a ƒë·ªçc
                                </button>
                                <button onclick="filterNotifications('order_status')" class="notification-filter-btn px-4 py-2 rounded-lg hover:bg-gray-100 text-gray-600 font-medium text-sm whitespace-nowrap">
                                    ƒê∆°n h√†ng
                                </button>
                                <button onclick="filterNotifications('news')" class="notification-filter-btn px-4 py-2 rounded-lg hover:bg-gray-100 text-gray-600 font-medium text-sm whitespace-nowrap">
                                    Tin t·ª©c
                                </button>
                                <button onclick="filterNotifications('promo')" class="notification-filter-btn px-4 py-2 rounded-lg hover:bg-gray-100 text-gray-600 font-medium text-sm whitespace-nowrap">
                                    Khuy·∫øn m√£i
                                </button>
                            </div>

                            <!-- Notifications List -->
                            <div id="account-notifications-list" class="space-y-3">
                                <!-- Loading skeleton -->
                                <div class="animate-pulse space-y-3">
                                    <div class="flex gap-3 p-4 bg-gray-50 rounded-lg">
                                        <div class="w-12 h-12 bg-gray-200 rounded-full"></div>
                                        <div class="flex-1">
                                            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                                            <div class="h-3 bg-gray-200 rounded w-full mb-2"></div>
                                            <div class="h-3 bg-gray-200 rounded w-1/4"></div>
                                        </div>
                                    </div>
                                    <div class="flex gap-3 p-4 bg-gray-50 rounded-lg">
                                        <div class="w-12 h-12 bg-gray-200 rounded-full"></div>
                                        <div class="flex-1">
                                            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                                            <div class="h-3 bg-gray-200 rounded w-full mb-2"></div>
                                            <div class="h-3 bg-gray-200 rounded w-1/4"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Load More Button -->
                            <div class="text-center mt-6">
                                <button id="load-more-notifications" class="px-6 py-2 text-orange-600 hover:text-orange-700 font-medium text-sm hidden">
                                    <i class="fas fa-chevron-down mr-2"></i>
                                    Xem th√™m
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Container -->
    <div id="footer-container"></div>

    <!-- Chatbot Container -->
    <div id="chatbot-container"></div>

    <!-- Back to Top Button (Mobile) -->
    <button id="back-to-top" class="fixed bottom-20 right-4 bg-orange-600 text-white w-12 h-12 rounded-full shadow-lg hover:bg-orange-700 transition-all opacity-0 pointer-events-none z-40 flex items-center justify-center">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Scripts -->
    <script>
        // API Configuration
        if (typeof window.API_URL === 'undefined') {
            window.API_URL = 'http://localhost:3000/api';
        }
    </script>
    <script src="js/loading.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/load-components.js"></script>
    <script src="js/cart.js"></script>
    <script>
        let isEditMode = false;
        let originalData = {};

        // Check login
        if (!isLoggedIn()) {
            window.location.href = 'dang-nhap.html';
        }

        // Load user data
        async function loadUserData() {
            try {
                const user = await getCurrentUser();
                if (!user) {
                    window.location.href = 'dang-nhap.html';
                    return;
                }

                // Display in sidebar
                document.getElementById('sidebar-username').textContent = user.ten_nguoi_dung;
                document.getElementById('sidebar-email').textContent = user.email;

                // Display avatar - s·ª≠ d·ª•ng h√†m getAvatarUrl ƒë·ªÉ x·ª≠ l√Ω nh·∫•t qu√°n
                const avatarDisplay = document.getElementById('avatar-display');
                const avatarUrl = typeof getAvatarUrl === 'function' 
                    ? getAvatarUrl(user.anh_dai_dien)
                    : (user.anh_dai_dien && user.anh_dai_dien.startsWith('http') 
                        ? user.anh_dai_dien 
                        : `${window.API_URL.replace('/api', '')}${user.anh_dai_dien || ''}`);
                
                if (avatarUrl) {
                    console.log('üñºÔ∏è Avatar URL (tai-khoan):', avatarUrl);
                    // Th√™m referrerpolicy ƒë·ªÉ tr√°nh b·ªã ch·∫∑n ·∫£nh t·ª´ Google
                    avatarDisplay.innerHTML = `<img src="${avatarUrl}" alt="${user.ten_nguoi_dung}" class="w-full h-full object-cover rounded-full" referrerpolicy="no-referrer" crossorigin="anonymous" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-user\\'></i>'">`;
                } else {
                    console.log('‚ö†Ô∏è No avatar found for user (tai-khoan)');
                }

                // Fill form
                document.getElementById('ten_nguoi_dung').value = user.ten_nguoi_dung || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('so_dien_thoai').value = user.so_dien_thoai || '';
                document.getElementById('dia_chi').value = user.dia_chi || '';
                document.getElementById('gioi_tinh').value = user.gioi_tinh || 'khac';

                // Store original data
                originalData = { ...user };
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng', 'error');
            }
        }

        // Show tab
        function showTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('bg-orange-50', 'text-orange-600', 'font-semibold');
                btn.classList.add('text-gray-700');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');

            // Add active class to clicked button
            if (event) {
                const button = event.currentTarget;
                button.classList.add('bg-orange-50', 'text-orange-600', 'font-semibold');
                button.classList.remove('text-gray-700');
            }
        }

        // Toggle edit mode
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const fields = ['ten_nguoi_dung', 'so_dien_thoai', 'dia_chi', 'gioi_tinh'];
            
            fields.forEach(field => {
                document.getElementById(field).disabled = !isEditMode;
            });

            document.getElementById('save-buttons').classList.toggle('hidden', !isEditMode);
            document.getElementById('edit-profile-btn').classList.toggle('hidden', isEditMode);
        }

        // Cancel edit
        function cancelEdit() {
            toggleEditMode();
            // Restore original data
            document.getElementById('ten_nguoi_dung').value = originalData.ten_nguoi_dung || '';
            document.getElementById('so_dien_thoai').value = originalData.so_dien_thoai || '';
            document.getElementById('dia_chi').value = originalData.dia_chi || '';
            document.getElementById('gioi_tinh').value = originalData.gioi_tinh || 'khac';
        }

        // Toggle password visibility
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = event.target.closest('button').querySelector('i');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Handle profile form submit
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                ten_nguoi_dung: document.getElementById('ten_nguoi_dung').value,
                so_dien_thoai: document.getElementById('so_dien_thoai').value,
                dia_chi: document.getElementById('dia_chi').value,
                gioi_tinh: document.getElementById('gioi_tinh').value
            };

            const result = await updateUserInfo(formData);
            
            if (result.success) {
                // Update localStorage
                const user = getUserData();
                Object.assign(user, formData);
                saveUserData(user);
                
                // Reload data
                await loadUserData();
                toggleEditMode();
                
                // Update navbar
                if (typeof updateUserMenu === 'function') {
                    updateUserMenu();
                }
            }
        });

        // Handle password form submit
        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const mat_khau_cu = document.getElementById('mat_khau_cu').value;
            const mat_khau_moi = document.getElementById('mat_khau_moi').value;
            const xac_nhan = document.getElementById('xac_nhan_mat_khau').value;

            // Validate
            if (mat_khau_moi !== xac_nhan) {
                showNotification('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp', 'error');
                return;
            }

            if (mat_khau_moi.length < 6) {
                showNotification('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±', 'error');
                return;
            }

            const result = await changePassword(mat_khau_cu, mat_khau_moi);
            
            if (result.success) {
                // Clear form
                document.getElementById('password-form').reset();
            }
        });

        // Handle avatar upload
        document.getElementById('avatar-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('File ·∫£nh qu√° l·ªõn (t·ªëi ƒëa 5MB)', 'error');
                e.target.value = '';
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Vui l√≤ng ch·ªçn file ·∫£nh', 'error');
                e.target.value = '';
                return;
            }

            // Show loading
            const uploadLoading = document.getElementById('upload-loading');
            uploadLoading.classList.remove('hidden');

            try {
                const token = localStorage.getItem('token');
                const formData = new FormData();
                formData.append('avatar', file);

                const response = await fetch(`${window.API_URL}/auth/upload-avatar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update avatar path
                    const updateResult = await updateUserInfo({
                        anh_dai_dien: result.data.anh_dai_dien
                    });

                    if (updateResult.success) {
                        // Update localStorage
                        const user = getUserData();
                        user.anh_dai_dien = result.data.anh_dai_dien;
                        saveUserData(user);

                        showNotification('C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán th√†nh c√¥ng!', 'success');
                        
                        // Reload page to show new avatar
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                } else {
                    showNotification(result.message || 'Upload ·∫£nh th·∫•t b·∫°i', 'error');
                    uploadLoading.classList.add('hidden');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showNotification('L·ªói khi upload ·∫£nh', 'error');
                uploadLoading.classList.add('hidden');
            }
            
            e.target.value = '';
        });

        // Mobile menu toggle
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebarMenu = document.getElementById('sidebar-menu');
        const menuChevron = document.getElementById('menu-chevron');

        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', () => {
                sidebarMenu.classList.toggle('hidden');
                sidebarMenu.classList.toggle('block');
                menuChevron.classList.toggle('rotate-180');
                
                // Add smooth animation
                if (!sidebarMenu.classList.contains('hidden')) {
                    sidebarMenu.style.animation = 'slideDown 0.3s ease-out';
                }
            });
        }

        // Close mobile menu when tab is selected on mobile
        function showTabMobile(tabName, event) {
            showTab(tabName, event);
            
            // Close menu on mobile after selection
            if (window.innerWidth < 1024) {
                setTimeout(() => {
                    sidebarMenu.classList.add('hidden');
                    sidebarMenu.classList.remove('block');
                    menuChevron.classList.remove('rotate-180');
                }, 100);
            }
        }

        // Update tab buttons to use mobile-friendly function on small screens
        document.querySelectorAll('.tab-button').forEach(button => {
            const originalOnclick = button.getAttribute('onclick');
            if (originalOnclick) {
                // Replace showTab with showTabMobile
                const newOnclick = originalOnclick.replace('showTab', 'showTabMobile');
                button.setAttribute('onclick', newOnclick);
            }
        });

        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            .tab-content {
                animation: fadeIn 0.3s ease-in;
            }

            /* Mobile optimizations */
            @media (max-width: 1023px) {
                #sidebar-menu {
                    position: relative !important;
                    top: 0 !important;
                }

                .tab-button {
                    font-size: 0.95rem;
                    padding: 0.875rem 1rem;
                }

                #avatar-display {
                    width: 80px !important;
                    height: 80px !important;
                }
            }

            /* Touch-friendly buttons on mobile */
            @media (max-width: 768px) {
                button, .tab-button, input[type="submit"] {
                    min-height: 44px;
                    touch-action: manipulation;
                }

                input, textarea, select {
                    font-size: 16px !important; /* Prevent zoom on iOS */
                }
            }

            /* Smooth scroll behavior */
            html {
                scroll-behavior: smooth;
            }

            /* Loading skeleton */
            .skeleton {
                background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                background-size: 200% 100%;
                animation: loading 1.5s infinite;
            }

            @keyframes loading {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }

            /* Pull to refresh hint (optional) */
            .pull-refresh-hint {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 60px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(to bottom, rgba(234, 88, 12, 0.1), transparent);
                opacity: 0;
                transform: translateY(-100%);
                transition: all 0.3s ease;
                z-index: 40;
            }
        `;
        document.head.appendChild(style);

        // Handle window resize
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (window.innerWidth >= 1024) {
                    // Show sidebar on desktop
                    sidebarMenu.classList.remove('hidden');
                    sidebarMenu.classList.add('block');
                } else {
                    // Hide sidebar on mobile
                    sidebarMenu.classList.add('hidden');
                    sidebarMenu.classList.remove('block');
                    menuChevron.classList.remove('rotate-180');
                }
            }, 250);
        });

        // Back to top button functionality
        const backToTopButton = document.getElementById('back-to-top');
        
        // Optimize scroll performance on mobile
        let ticking = false;
        let lastScrollY = window.scrollY;

        window.addEventListener('scroll', () => {
            lastScrollY = window.scrollY;

            if (!ticking) {
                window.requestAnimationFrame(() => {
                    // Show/hide back to top button
                    if (backToTopButton) {
                        if (lastScrollY > 300) {
                            backToTopButton.style.opacity = '1';
                            backToTopButton.style.pointerEvents = 'auto';
                        } else {
                            backToTopButton.style.opacity = '0';
                            backToTopButton.style.pointerEvents = 'none';
                        }
                    }
                    ticking = false;
                });
                ticking = true;
            }
        }, { passive: true });

        // Back to top click handler
        if (backToTopButton) {
            backToTopButton.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
                // Haptic feedback
                if ('vibrate' in navigator) {
                    navigator.vibrate(20);
                }
            });
        }

        // Handle orientation change on mobile
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                window.scrollTo(0, window.scrollY);
            }, 100);
        });

        // Add haptic feedback for touch devices (if supported)
        if ('vibrate' in navigator) {
            document.querySelectorAll('button, .tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    navigator.vibrate(10); // Light haptic feedback
                });
            });
        }

        // Prevent double-tap zoom on buttons
        document.querySelectorAll('button').forEach(button => {
            let lastTap = 0;
            button.addEventListener('touchend', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 500 && tapLength > 0) {
                    e.preventDefault();
                }
                lastTap = currentTime;
            });
        });

        // Swipe gesture for mobile tab switching
        let touchStartX = 0;
        let touchEndX = 0;
        const tabContents = document.querySelectorAll('.tab-content');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabs = ['profile', 'password', 'orders', 'reservations'];
        
        function getCurrentTabIndex() {
            for (let i = 0; i < tabs.length; i++) {
                if (!document.getElementById(`${tabs[i]}-tab`).classList.contains('hidden')) {
                    return i;
                }
            }
            return 0;
        }

        function switchToTab(index) {
            if (index >= 0 && index < tabs.length) {
                const tabButton = tabButtons[index];
                if (tabButton) {
                    tabButton.click();
                }
            }
        }

        // Add swipe detection on mobile
        if (window.innerWidth < 1024) {
            document.querySelector('.lg\\:col-span-3').addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            document.querySelector('.lg\\:col-span-3').addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });
        }

        function handleSwipe() {
            const swipeThreshold = 50;
            const difference = touchStartX - touchEndX;
            
            if (Math.abs(difference) > swipeThreshold) {
                const currentIndex = getCurrentTabIndex();
                
                if (difference > 0) {
                    // Swipe left - next tab
                    switchToTab(currentIndex + 1);
                } else {
                    // Swipe right - previous tab
                    switchToTab(currentIndex - 1);
                }
            }
        }

        // Add visual indicator for swipeable content on mobile
        if (window.innerWidth < 1024) {
            const style = document.createElement('div');
            style.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-xs opacity-0 pointer-events-none transition-opacity z-50';
            style.id = 'swipe-hint';
            style.innerHTML = '<i class="fas fa-hand-point-left mr-2"></i>Vu·ªët ƒë·ªÉ chuy·ªÉn tab<i class="fas fa-hand-point-right ml-2"></i>';
            document.body.appendChild(style);

            // Show hint briefly on first load
            setTimeout(() => {
                const hint = document.getElementById('swipe-hint');
                hint.style.opacity = '0.9';
                setTimeout(() => {
                    hint.style.opacity = '0';
                }, 3000);
            }, 1000);
        }

        // ===== NOTIFICATION HANDLING =====
        let allNotifications = [];
        let currentFilter = 'all';
        let notificationPage = 1;
        const notificationsPerPage = 20;

        // Load notifications for account page
        async function loadAccountNotifications() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch(`http://localhost:3000/api/notifications?limit=100`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();

                if (result.success) {
                    allNotifications = result.data || [];
                    renderAccountNotifications();
                    updateNotificationBadge(result.unreadCount || 0);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('account-notifications-list').innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-exclamation-circle text-4xl mb-3 opacity-30"></i>
                        <p>Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o</p>
                    </div>
                `;
            }
        }

        // Filter notifications
        function filterNotifications(type) {
            currentFilter = type;
            notificationPage = 1;
            
            // Update filter buttons
            document.querySelectorAll('.notification-filter-btn').forEach(btn => {
                btn.classList.remove('bg-orange-50', 'text-orange-600');
                btn.classList.add('hover:bg-gray-100', 'text-gray-600');
            });
            event.target.classList.add('bg-orange-50', 'text-orange-600');
            event.target.classList.remove('hover:bg-gray-100', 'text-gray-600');
            
            renderAccountNotifications();
        }

        // Render notifications
        function renderAccountNotifications() {
            const container = document.getElementById('account-notifications-list');
            
            let filtered = allNotifications;
            if (currentFilter === 'unread') {
                filtered = allNotifications.filter(n => !n.da_doc);
            } else if (currentFilter !== 'all') {
                filtered = allNotifications.filter(n => n.loai === currentFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-bell-slash text-4xl mb-3 opacity-30"></i>
                        <p>Kh√¥ng c√≥ th√¥ng b√°o</p>
                    </div>
                `;
                return;
            }

            const displayCount = notificationPage * notificationsPerPage;
            const toDisplay = filtered.slice(0, displayCount);

            container.innerHTML = toDisplay.map(notif => {
                const icon = getNotificationIcon(notif.loai);
                const timeAgo = getTimeAgo(notif.ngay_tao);
                const unreadClass = notif.da_doc ? '' : 'bg-orange-50 border-l-4 border-orange-500';

                return `
                    <div class="notification-item-account flex gap-3 p-4 rounded-lg hover:bg-gray-50 cursor-pointer transition ${unreadClass}" 
                         data-id="${notif.ma_thong_bao}" 
                         data-link="${notif.duong_dan || ''}"
                         onclick="handleNotificationClick(${notif.ma_thong_bao}, '${notif.duong_dan || ''}')">
                        <div class="flex-shrink-0 w-12 h-12 rounded-full ${icon.bgColor} flex items-center justify-center">
                            <i class="${icon.icon} ${icon.textColor} text-lg"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-gray-800 mb-1 ${notif.da_doc ? '' : 'font-bold'}">${notif.tieu_de}</h4>
                            <p class="text-sm text-gray-600 mb-2 line-clamp-2">${notif.noi_dung || ''}</p>
                            <div class="flex items-center gap-3 text-xs text-gray-400">
                                <span><i class="far fa-clock mr-1"></i>${timeAgo}</span>
                                ${!notif.da_doc ? '<span class="text-orange-600 font-medium"><i class="fas fa-circle mr-1" style="font-size: 6px;"></i>M·ªõi</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Show/hide load more button
            const loadMoreBtn = document.getElementById('load-more-notifications');
            if (filtered.length > displayCount) {
                loadMoreBtn.classList.remove('hidden');
            } else {
                loadMoreBtn.classList.add('hidden');
            }
        }

        // Handle notification click
        async function handleNotificationClick(id, link) {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                await fetch(`http://localhost:3000/api/notifications/${id}/read`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Update local data
                const notif = allNotifications.find(n => n.ma_thong_bao === id);
                if (notif) notif.da_doc = true;
                
                renderAccountNotifications();
                
                // Navigate if link exists
                if (link) {
                    window.location.href = link;
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Mark all as read
        document.getElementById('mark-all-read-account')?.addEventListener('click', async () => {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                await fetch('http://localhost:3000/api/notifications/read-all', {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                allNotifications.forEach(n => n.da_doc = true);
                renderAccountNotifications();
                updateNotificationBadge(0);
                showNotification('ƒê√£ ƒë√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc', 'success');
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        });

        // Load more notifications
        document.getElementById('load-more-notifications')?.addEventListener('click', () => {
            notificationPage++;
            renderAccountNotifications();
        });

        // Update notification badge in sidebar
        function updateNotificationBadge(count) {
            const badge = document.getElementById('sidebar-notification-badge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // Helper functions
        function getNotificationIcon(type) {
            const icons = {
                news: { icon: 'fas fa-newspaper', bgColor: 'bg-blue-100', textColor: 'text-blue-600' },
                promo: { icon: 'fas fa-tag', bgColor: 'bg-green-100', textColor: 'text-green-600' },
                comment_reply: { icon: 'fas fa-reply', bgColor: 'bg-purple-100', textColor: 'text-purple-600' },
                comment_like: { icon: 'fas fa-heart', bgColor: 'bg-red-100', textColor: 'text-red-600' },
                order_status: { icon: 'fas fa-shopping-bag', bgColor: 'bg-orange-100', textColor: 'text-orange-600' },
                system: { icon: 'fas fa-bell', bgColor: 'bg-gray-100', textColor: 'text-gray-600' }
            };
            return icons[type] || icons.system;
        }

        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'V·ª´a xong';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} ph√∫t tr∆∞·ªõc`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} gi·ªù tr∆∞·ªõc`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} ng√†y tr∆∞·ªõc`;
            
            return date.toLocaleDateString('vi-VN');
        }

        // Check URL hash for notifications tab
        if (window.location.hash === '#notifications') {
            setTimeout(() => {
                const notifButton = document.querySelector('[onclick*="notifications"]');
                if (notifButton) {
                    notifButton.click();
                    loadAccountNotifications();
                }
            }, 500);
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            
            // Initialize mobile menu state
            if (window.innerWidth >= 1024) {
                sidebarMenu.classList.remove('hidden');
                sidebarMenu.classList.add('block');
            }

            // Load notifications if on notifications tab
            if (window.location.hash === '#notifications') {
                loadAccountNotifications();
            }
        });

        // Make filterNotifications global
        window.filterNotifications = filterNotifications;
        window.handleNotificationClick = handleNotificationClick;
    </script>
    
    <!-- Snow Effect -->
    <script src="js/snow-effect.js"></script>
    
    <!-- Cherry Blossom Effect -->
    <script src="js/cherry-blossom-effect.js"></script>
    
    <!-- Responsive Helper -->
    <script src="js/responsive-helper.js"></script>
</body>

</html>
