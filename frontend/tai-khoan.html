<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√†i kho·∫£n c·ªßa t√¥i - Nh√† h√†ng Ph∆∞∆°ng Nam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/modern-style.css">
</head>

<body class="bg-gradient-to-br from-orange-50 via-red-50 to-yellow-50">
    <!-- Navigation Container -->
    <div id="navbar-container"></div>

    <!-- Account Section -->
    <section class="py-24">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                    <div class="flex items-center space-x-6">
                        <div class="relative">
                            <div id="user-avatar"
                                class="w-24 h-24 rounded-full bg-orange-100 flex items-center justify-center border-4 border-orange-200 overflow-hidden transition-all duration-300 hover:border-orange-400">
                                <i class="fas fa-user text-4xl text-orange-600"></i>
                            </div>
                            <label for="avatar-input" 
                                   class="absolute bottom-0 right-0 bg-orange-600 text-white w-8 h-8 rounded-full flex items-center justify-center cursor-pointer hover:bg-orange-700 transition shadow-lg"
                                   title="ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán">
                                <i class="fas fa-camera text-xs"></i>
                            </label>
                            <input type="file" id="avatar-input" accept="image/*" class="hidden">
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800" id="user-name">ƒêang t·∫£i...</h1>
                            <p class="text-gray-600" id="user-email"></p>
                            <p class="text-sm text-gray-500 mt-1">
                                <i class="fas fa-calendar mr-1"></i>
                                Tham gia: <span id="user-join-date"></span>
                            </p>
                            <p id="upload-status" class="text-sm font-semibold mt-2 hidden transition-all duration-300"></p>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    <div class="border-b border-gray-200">
                        <nav class="flex">
                            <button onclick="showTab('info')" id="tab-info"
                                class="tab-button active px-6 py-4 text-gray-700 font-medium border-b-2 border-orange-600">
                                <i class="fas fa-user mr-2"></i> Th√¥ng tin c√° nh√¢n
                            </button>
                            <button onclick="showTab('orders')" id="tab-orders"
                                class="tab-button px-6 py-4 text-gray-500 font-medium border-b-2 border-transparent hover:text-gray-700">
                                <i class="fas fa-shopping-bag mr-2"></i> ƒê∆°n h√†ng
                            </button>
                            <button onclick="showTab('password')" id="tab-password"
                                class="tab-button px-6 py-4 text-gray-500 font-medium border-b-2 border-transparent hover:text-gray-700">
                                <i class="fas fa-lock mr-2"></i> ƒê·ªïi m·∫≠t kh·∫©u
                            </button>
                        </nav>
                    </div>

                    <!-- Tab Content -->
                    <div class="p-8">
                        <!-- Info Tab -->
                        <div id="content-info" class="tab-content">
                            <form id="update-info-form" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">H·ªç v√† t√™n</label>
                                        <input type="text" id="ten_nguoi_dung"
                                            class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-orange-600">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">S·ªë ƒëi·ªán tho·∫°i</label>
                                        <input type="tel" id="so_dien_thoai"
                                            class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-orange-600">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">ƒê·ªãa ch·ªâ</label>
                                    <input type="text" id="dia_chi"
                                        class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-orange-600">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Gi·ªõi t√≠nh</label>
                                    <select id="gioi_tinh"
                                        class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-orange-600">
                                        <option value="khac">Kh√°c</option>
                                        <option value="nam">Nam</option>
                                        <option value="nu">N·ªØ</option>
                                    </select>
                                </div>
                                <button type="submit"
                                    class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition">
                                    <i class="fas fa-save mr-2"></i> L∆∞u thay ƒë·ªïi
                                </button>
                            </form>
                        </div>

                        <!-- Orders Tab -->
                        <div id="content-orders" class="tab-content hidden">
                            <p class="text-gray-600">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>
                        </div>

                        <!-- Password Tab -->
                        <div id="content-password" class="tab-content hidden">
                            <form id="change-password-form" class="space-y-4 max-w-md">
                                <div>
                                    <label class="block text-sm font-medium mb-2">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                                    <input type="password" id="mat_khau_cu" required
                                        class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-orange-600">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">M·∫≠t kh·∫©u m·ªõi</label>
                                    <input type="password" id="mat_khau_moi" required minlength="6"
                                        class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-orange-600">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                                    <input type="password" id="xac_nhan_mat_khau_moi" required minlength="6"
                                        class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-orange-600">
                                </div>
                                <button type="submit"
                                    class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition">
                                    <i class="fas fa-key mr-2"></i> ƒê·ªïi m·∫≠t kh·∫©u
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer Container -->
    <div id="footer-container"></div>

    <script src="js/auth.js"></script>
    <script src="js/load-components.js"></script>
    <script>
        // Check if user is logged in
        const user = getUserData();
        if (!user) {
            window.location.href = 'dang-nhap.html';
        }

        // Upload avatar handler
        let uploadedAvatarPath = null;
        
        document.getElementById('avatar-input').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            console.log('üì∏ Uploading avatar:', file.name);

            // Validate file size
            if (file.size > 5 * 1024 * 1024) {
                showNotification('K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB', 'error');
                this.value = '';
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Vui l√≤ng ch·ªçn file ·∫£nh', 'error');
                this.value = '';
                return;
            }

            // Show uploading status
            const statusEl = document.getElementById('upload-status');
            statusEl.textContent = '‚è≥ ƒêang t·∫£i ·∫£nh...';
            statusEl.classList.remove('hidden', 'text-green-600', 'text-red-600');
            statusEl.classList.add('text-blue-600');

            // ‚ú® PREVIEW ·∫¢NH NGAY L·∫¨P T·ª®C
            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log('‚úÖ FileReader onload triggered');
                
                const avatarDiv = document.getElementById('user-avatar');
                
                // X√≥a to√†n b·ªô n·ªôi dung c≈©
                avatarDiv.innerHTML = '';
                console.log('üóëÔ∏è Cleared old content');
                
                // T·∫°o th·∫ª img m·ªõi
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'w-full h-full object-cover';
                img.alt = 'Avatar Preview';
                
                img.onload = function() {
                    console.log('üñºÔ∏è Preview image loaded and displayed');
                };
                
                img.onerror = function() {
                    console.error('‚ùå Failed to display preview');
                };
                
                avatarDiv.appendChild(img);
                console.log('ÔøΩ Preview image added to avatar div');
            };
            
            reader.onerror = function() {
                console.error('‚ùå FileReader error');
            };
            
            reader.readAsDataURL(file);
            console.log('ÔøΩ FileReader started...');

            // Upload to server
            const formData = new FormData();
            formData.append('avatar', file);

            try {
                const response = await fetch('http://localhost:3000/api/auth/upload-avatar', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    uploadedAvatarPath = result.data.anh_dai_dien;
                    statusEl.textContent = '‚è≥ ƒêang l∆∞u...';
                    
                    // Update avatar in database immediately
                    const token = localStorage.getItem('token');
                    const updateResponse = await fetch('http://localhost:3000/api/auth/update', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            anh_dai_dien: uploadedAvatarPath
                        })
                    });

                    const updateResult = await updateResponse.json();

                    if (updateResult.success) {
                        statusEl.textContent = '‚úÖ ƒê√£ l∆∞u ·∫£nh ƒë·∫°i di·ªán!';
                        statusEl.classList.remove('text-blue-600', 'text-red-600');
                        statusEl.classList.add('text-green-600');
                        
                        // Update user data in localStorage
                        const user = getUserData();
                        user.anh_dai_dien = uploadedAvatarPath;
                        localStorage.setItem('user', JSON.stringify(user));
                        
                        // ‚ú® Visual feedback R√ï R√ÄNG: ·∫¢nh ƒë√£ ƒë∆∞·ª£c l∆∞u
                        const avatarDiv = document.getElementById('user-avatar');
                        
                        // Border xanh + animation scale
                        avatarDiv.classList.remove('border-orange-200', 'border-red-400');
                        avatarDiv.classList.add('border-green-500', 'border-4');
                        avatarDiv.style.transform = 'scale(1.05)';
                        avatarDiv.style.transition = 'all 0.3s ease';
                        
                        // Th√™m badge "ƒê√£ l∆∞u" n·ªïi b·∫≠t
                        const savedBadge = document.createElement('div');
                        savedBadge.className = 'absolute -top-2 -right-2 bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg animate-bounce';
                        savedBadge.innerHTML = '‚úì ƒê√£ l∆∞u';
                        avatarDiv.parentElement.appendChild(savedBadge);
                        
                        setTimeout(() => {
                            // Reset v·ªÅ tr·∫°ng th√°i b√¨nh th∆∞·ªùng
                            avatarDiv.classList.remove('border-green-500', 'border-4');
                            avatarDiv.classList.add('border-orange-200');
                            avatarDiv.style.transform = 'scale(1)';
                            statusEl.classList.add('hidden');
                            savedBadge.remove();
                        }, 3000);
                        
                        showNotification('‚úÖ ·∫¢nh ƒë·∫°i di·ªán ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o h·ªá th·ªëng!', 'success');
                        
                        // Update navbar avatar - C·∫¨P NH·∫¨T NAVBAR NGAY L·∫¨P T·ª®C
                        if (typeof window.updateUserMenu === 'function') {
                            window.updateUserMenu();
                        }
                        
                        console.log('‚úÖ Avatar updated:', uploadedAvatarPath);
                    } else {
                        throw new Error(updateResult.message || 'Kh√¥ng th·ªÉ l∆∞u ·∫£nh');
                    }
                } else {
                    statusEl.textContent = '‚ùå Upload th·∫•t b·∫°i';
                    statusEl.classList.remove('text-blue-600', 'text-green-600');
                    statusEl.classList.add('text-red-600');
                    
                    showNotification(result.message || 'Upload ·∫£nh th·∫•t b·∫°i', 'error');
                    uploadedAvatarPath = null;
                }
            } catch (error) {
                console.error('L·ªói upload:', error);
                statusEl.textContent = '‚ùå ' + (error.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server');
                statusEl.classList.remove('text-blue-600', 'text-green-600');
                statusEl.classList.add('text-red-600');
                
                showNotification('Kh√¥ng th·ªÉ upload ·∫£nh', 'error');
                uploadedAvatarPath = null;
            }
        });

        // Load user data
        async function loadUserData() {
            try {
                const currentUser = await getCurrentUser();
                if (currentUser) {
                    // Update header
                    document.getElementById('user-name').textContent = currentUser.ten_nguoi_dung;
                    document.getElementById('user-email').textContent = currentUser.email;
                    document.getElementById('user-join-date').textContent = new Date(currentUser.ngay_tao).toLocaleDateString('vi-VN');

                    // Update avatar - QUAN TR·ªåNG: ki·ªÉm tra c·∫©n th·∫≠n
                    const avatarDiv = document.getElementById('user-avatar');
                    if (currentUser.anh_dai_dien) {
                        const avatarUrl = `http://localhost:3000${currentUser.anh_dai_dien}`;
                        console.log('üñºÔ∏è Loading avatar from:', avatarUrl);
                        avatarDiv.innerHTML = `
                            <img src="${avatarUrl}" 
                                 class="w-full h-full object-cover rounded-full" 
                                 alt="${currentUser.ten_nguoi_dung}"
                                 onerror="console.error('Failed to load avatar:', this.src); this.parentElement.innerHTML='<i class=\\'fas fa-user text-4xl text-orange-600\\'></i>'">
                        `;
                    } else {
                        console.log('‚ÑπÔ∏è No avatar found, showing default icon');
                        avatarDiv.innerHTML = `<i class="fas fa-user text-4xl text-orange-600"></i>`;
                    }

                    // Fill form
                    document.getElementById('ten_nguoi_dung').value = currentUser.ten_nguoi_dung || '';
                    document.getElementById('so_dien_thoai').value = currentUser.so_dien_thoai || '';
                    document.getElementById('dia_chi').value = currentUser.dia_chi || '';
                    document.getElementById('gioi_tinh').value = currentUser.gioi_tinh || 'khac';
                }
            } catch (error) {
                console.error('‚ùå Error loading user data:', error);
            }
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-orange-600', 'text-gray-700');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('active', 'border-orange-600', 'text-gray-700');
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
        }

        // Update info form
        document.getElementById('update-info-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            // Ch·ªâ g·ª≠i c√°c field c√≥ gi√° tr·ªã (kh√¥ng r·ªóng)
            const formData = {};
            
            const ten_nguoi_dung = document.getElementById('ten_nguoi_dung').value.trim();
            const so_dien_thoai = document.getElementById('so_dien_thoai').value.trim();
            const dia_chi = document.getElementById('dia_chi').value.trim();
            const gioi_tinh = document.getElementById('gioi_tinh').value;
            
            if (ten_nguoi_dung) formData.ten_nguoi_dung = ten_nguoi_dung;
            if (so_dien_thoai) formData.so_dien_thoai = so_dien_thoai;
            if (dia_chi) formData.dia_chi = dia_chi;
            if (gioi_tinh) formData.gioi_tinh = gioi_tinh;

            // Ki·ªÉm tra c√≥ field n√†o ƒë∆∞·ª£c c·∫≠p nh·∫≠t kh√¥ng
            if (Object.keys(formData).length === 0) {
                showNotification('Vui l√≤ng nh·∫≠p th√¥ng tin c·∫ßn c·∫≠p nh·∫≠t', 'error');
                return;
            }

            const result = await updateUserInfo(formData);
            if (result && result.success) {
                // Update localStorage
                const user = getUserData();
                if (formData.ten_nguoi_dung) user.ten_nguoi_dung = formData.ten_nguoi_dung;
                if (formData.so_dien_thoai) user.so_dien_thoai = formData.so_dien_thoai;
                if (formData.dia_chi) user.dia_chi = formData.dia_chi;
                if (formData.gioi_tinh) user.gioi_tinh = formData.gioi_tinh;
                localStorage.setItem('user', JSON.stringify(user));

                // Update display ngay l·∫≠p t·ª©c KH√îNG RELOAD
                document.getElementById('user-name').textContent = user.ten_nguoi_dung;
                
                // Update navbar
                if (typeof window.updateUserMenu === 'function') {
                    window.updateUserMenu();
                }
            }
        });

        // Change password form
        document.getElementById('change-password-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const mat_khau_cu = document.getElementById('mat_khau_cu').value;
            const mat_khau_moi = document.getElementById('mat_khau_moi').value;
            const xac_nhan = document.getElementById('xac_nhan_mat_khau_moi').value;

            if (mat_khau_moi !== xac_nhan) {
                showNotification('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp', 'error');
                return;
            }

            const result = await changePassword(mat_khau_cu, mat_khau_moi);
            if (result && result.success) {
                this.reset();
            }
        });

        // Load data on page load
        loadUserData();
    </script>
</body>

</html>